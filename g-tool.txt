
I am going to create a land tools for bangladesh jamalpur district.
Survey record 'dlrms_khatians_RS'. jamalpur use  'dlrms_khatians_RS' for old land record data.
 'namjari_khatians'  = new land record
 'dlrms_khatians_RS' = old record.

# tools/search-khatian.php

  <?php
// This file is intended to be included by a main PHP file (e.g., tools.php)
// That main file should load Tailwind CSS, Font Awesome, and potentially set the API_BASE_URL JS variable.
// DO NOT include <html>, <head>, <body> here.
?>

    <div class="container mx-auto px-2 py-4" x-data="landSearchEnhanced()" x-init="fetchDivisions()" x-cloak>

        <?php // --- Filter Panel --- ?>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md mb-6 border border-gray-200 dark:border-gray-700">
            <h2 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200 border-b pb-2 dark:border-gray-600">অনুসন্ধানের ফিল্টার</h2>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-4">

                <?php // Location Filters: Division, District, Upazila, Survey ?>
                <div>
                    <label for="division_select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">বিভাগ <span x-show="loadingDivisions" class="ml-1 text-emerald-500"><i class="fas fa-spinner fa-spin text-xs"></i></span></label>
                    <select id="division_select" x-model="selectedDivision" @change="fetchDistricts()"
                            class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500 text-sm dark:bg-gray-700 dark:text-gray-200 disabled:opacity-50"
                            :disabled="loadingDivisions">
                        <option value="">-- নির্বাচন করুন --</option>
                        <template x-for="division in divisions" :key="division.id">
                            <option :value="division.id" x-text="division.name"></option>
                        </template>
                    </select>
                </div>
                <div>
                    <label for="district_select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">জেলা <span x-show="loadingDistricts" class="ml-1 text-emerald-500"><i class="fas fa-spinner fa-spin text-xs"></i></span></label>
                    <select id="district_select" x-model="selectedDistrict" @change="fetchUpazilas()"
                            class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500 text-sm dark:bg-gray-700 dark:text-gray-200 disabled:opacity-50"
                            :disabled="!selectedDivision || loadingDistricts">
                        <option value="">-- নির্বাচন করুন --</option>
                        <template x-for="district in districts" :key="district.id">
                            <option :value="district.id" :data-bbs_code="district.bbs_code" x-text="district.name"></option>
                        </template>
                    </select>
                </div>
                <div>
                    <label for="upazila_select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">উপজেলা/থানা <span x-show="loadingUpazilas" class="ml-1 text-emerald-500"><i class="fas fa-spinner fa-spin text-xs"></i></span></label>
                    <select id="upazila_select" x-model="selectedUpazila" @change="fetchSurveys()"
                            class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500 text-sm dark:bg-gray-700 dark:text-gray-200 disabled:opacity-50"
                            :disabled="!selectedDistrict || loadingUpazilas">
                        <option value="">-- নির্বাচন করুন --</option>
                        <template x-for="upazila in upazilas" :key="upazila.id">
                            <option :value="upazila.id" :data-bbs_code="upazila.bbs_code" x-text="upazila.name"></option>
                        </template>
                    </select>
                </div>
                <div>
                    <label for="survey_select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">খতিয়ানের ধরণ <span x-show="loadingSurveys" class="ml-1 text-emerald-500"><i class="fas fa-spinner fa-spin text-xs"></i></span></label>
                    <select id="survey_select" x-model="selectedSurvey" @change="fetchMouzas()"
                            class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500 text-sm dark:bg-gray-700 dark:text-gray-200 disabled:opacity-50"
                            :disabled="!selectedUpazila || loadingSurveys">
                        <option value="">-- নির্বাচন করুন --</option>
                        <template x-for="survey in surveys" :key="survey.survey_id">
                            <option :value="survey.survey_id" x-text="survey.local_name"></option>
                        </template>
                    </select>
                </div>

                <?php // Mouza Filter & Selection ?>
                <div class="lg:col-span-2">
                    <label for="mouza_search_input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">মৌজা খুঁজুন ও নির্বাচন করুন <span x-show="loadingMouzas" class="ml-1 text-emerald-500"><i class="fas fa-spinner fa-spin text-xs"></i></span></label>
                    <input type="text" id="mouza_search_input" x-model="mouzaSearchInput"
                           placeholder="মৌজার নাম বা জে.এল. নং..." aria-label="মৌজা ফিল্টার করুন"
                           class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500 text-sm dark:bg-gray-700 dark:text-gray-200 disabled:opacity-50 mb-1"
                           :disabled="!selectedSurvey || loadingMouzas">
                    <div class="border rounded-md max-h-48 overflow-y-auto bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 divide-y divide-gray-200 dark:divide-gray-600">
                        <div x-show="!loadingMouzas && selectedSurvey && filteredMouzas.length === 0" class="p-3 text-center text-sm text-gray-500 dark:text-gray-400 italic">
                            <span x-show="mouzaSearchInput">"'<span x-text="mouzaSearchInput"></span>'" এর জন্য কোন মৌজা পাওয়া যায়নি।</span>
                            <span x-show="!mouzaSearchInput">কোন মৌজা লোড হয়নি বা পাওয়া যায়নি।</span>
                        </div>
                        <div x-show="!loadingMouzas && !selectedSurvey" class="p-3 text-center text-sm text-gray-500 dark:text-gray-400 italic">
                            মৌজা দেখতে আগে জরিপের ধরণ নির্বাচন করুন।
                        </div>
                        <template x-for="mouza in filteredMouzas" :key="mouza.id">
                            <div @click="selectMouza(mouza.id)"
                                 class="px-3 py-2 cursor-pointer hover:bg-emerald-50 dark:hover:bg-emerald-900/50"
                                 :class="{ 'bg-emerald-100 dark:bg-emerald-800 font-semibold': selectedMouzaId == mouza.id }"
                                 role="option" :aria-selected="selectedMouzaId == mouza.id">
                                <span class="text-sm text-gray-800 dark:text-gray-200" x-text="mouza.mouza_name"></span>
                                <span class="text-xs font-mono text-gray-600 dark:text-gray-400 ml-1">(জে.এল. <span x-text="mouza.jl_number"></span>)</span>
                            </div>
                        </template>
                        <div x-show="loadingMouzas" class="p-3 text-center text-sm text-gray-500 dark:text-gray-400 italic">
                            <i class="fas fa-spinner fa-spin mr-1"></i> মৌজা লোড হচ্ছে...
                        </div>
                    </div>
                </div>
            </div>

            <?php // Server Search Filters (Khatian No, Dag No - Trigger search on type/debounce) ?>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 pt-4 border-t dark:border-gray-600">
                <div>
                    <label for="khatian_search" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">খতিয়ান নং দিয়ে খুঁজুন</label>
                    <input type="search" id="khatian_search"
                           x-model.debounce.500ms="khatianSearch"
                           @input="triggerServerSearch()"
                           @keydown.enter.prevent="searchKhatiansNow()"
                           placeholder="খতিয়ান নং..." :disabled="!selectedMouzaId"
                           class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500 text-sm dark:bg-gray-700 dark:text-gray-200 disabled:opacity-50">
                </div>
                <div>
                    <label for="dag_search" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">দাগ নং দিয়ে খুঁজুন</label>
                    <input type="search" id="dag_search"
                           x-model.debounce.500ms="dagSearch"
                           @input="triggerServerSearch()"
                           @keydown.enter.prevent="searchKhatiansNow()"
                           placeholder="দাগ নং..." :disabled="!selectedMouzaId"
                           class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500 text-sm dark:bg-gray-700 dark:text-gray-200 disabled:opacity-50">
                </div>
                <div class="sm:col-span-2 lg:col-span-1 flex items-end">
                    <button @click="searchKhatiansNow()" :disabled="!selectedMouzaId || loadingKhatians"
                            class="w-full sm:w-auto justify-center px-6 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-md shadow-sm disabled:opacity-50 disabled:cursor-not-allowed transition duration-150 ease-in-out">
                        <span x-show="!loadingKhatians"><i class="fas fa-search mr-1"></i> এখনই খুঁজুন</span>
                        <span x-show="loadingKhatians"><i class="fas fa-spinner fa-spin mr-1"></i> খুঁজছে...</span>
                    </button>
                </div>
            </div>

            <?php // Global Error Message Area ?>
            <div x-show="errorMessage" x-transition
                 class="mt-4 p-3 bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 border border-red-300 dark:border-red-700 rounded text-sm"
                 role="alert" aria-live="assertive"
                 x-text="errorMessage">
            </div>

        </div> <?php // End Filter Panel ?>


        <?php // --- Results Panel --- ?>
        <div id="resultsPanel" class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 min-h-[200px] flex flex-col justify-between">

            <div> <?php // Content Area ?>
                <div class="border-b pb-2 dark:border-gray-600 mb-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 flex items-center gap-2 flex-wrap">
                        <span>খতিয়ানের তালিকা</span>
                        <span class="text-sm font-normal bg-gray-100 dark:bg-gray-700 px-2 py-0.5 rounded whitespace-nowrap" x-show="totalKhatians > 0 && !loadingKhatians">
                         মোট: <span x-text="totalKhatians"></span>
                         <span x-show="clientKhatianFilter && displayedKhatians.length != allKhatiansForPage.length"> (ফিল্টারকৃত <span x-text="displayedKhatians.length"></span>)</span>
                     </span>
                        <span x-show="loadingKhatians" class="text-emerald-500"><i class="fas fa-spinner fa-spin"></i></span>
                    </h3>
                    <?php // Client-Side Filter Input for Khatian List ?>
                    <div class="w-full sm:w-auto sm:max-w-xs flex-shrink-0">
                        <label for="client_khatian_filter" class="sr-only">বর্তমান তালিকা ফিল্টার করুন (খতিয়ান নং, দাগ, মালিক)</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-filter text-gray-400 text-xs"></i>
                            </div>
                            <input type="search" id="client_khatian_filter"
                                   x-model.debounce.300ms="clientKhatianFilter"
                                   placeholder="এই পাতার তালিকা ফিল্টার..."
                                   aria-label="বর্তমান তালিকা ফিল্টার করুন (খতিয়ান নং, দাগ, মালিক)"
                                   :disabled="loadingKhatians || allKhatiansForPage.length === 0"
                                   class="w-full p-2 pl-8 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500 text-sm dark:bg-gray-700 dark:text-gray-200 disabled:opacity-50">
                        </div>
                    </div>
                </div>

                <?php // Loading State ?>
                <div x-show="loadingKhatians && allKhatiansForPage.length === 0" class="text-center py-10 text-gray-500 dark:text-gray-400">
                    <i class="fas fa-spinner fa-spin text-3xl text-emerald-500"></i>
                    <p class="mt-2">খতিয়ান লোড হচ্ছে...</p>
                </div>

                <?php // Initial/Empty State ?>
                <div x-show="!loadingKhatians && !selectedMouzaId && !errorMessage" class="text-center py-10 text-gray-500 dark:text-gray-400">
                    <i class="fas fa-info-circle text-3xl text-blue-500"></i>
                    <p class="mt-2">অনুসন্ধানের জন্য উপরের ফিল্টার ব্যবহার করে বিভাগ, জেলা, উপজেলা, জরিপ এবং মৌজা নির্বাচন করুন।</p>
                </div>

                <?php // No Server Results State ?>
                <div x-show="!loadingKhatians && selectedMouzaId && totalKhatians === 0 && !errorMessage" class="text-center py-10 text-gray-500 dark:text-gray-400">
                    <i class="fas fa-exclamation-circle text-3xl text-amber-500"></i>
                    <p class="mt-2">আপনার অনুসন্ধানে কোন খতিয়ান পাওয়া যায়নি। ফিল্টার পরিবর্তন করে আবার চেষ্টা করুন।</p>
                </div>

                <?php // No Client Filter Results State ?>
                <div x-show="!loadingKhatians && totalKhatians > 0 && displayedKhatians.length === 0 && clientKhatianFilter" class="text-center py-10 text-gray-500 dark:text-gray-400">
                    <i class="fas fa-filter text-3xl text-orange-500"></i>
                    <p class="mt-2">"'<span x-text="clientKhatianFilter"></span>'" দিয়ে ফিল্টার করে এই পৃষ্ঠায় কিছু পাওয়া যায়নি।</p>
                </div>

                <?php // Results List (Uses displayedKhatians) ?>
                <div x-show="!loadingKhatians && displayedKhatians.length > 0" aria-live="polite">
                    <ul class="divide-y divide-gray-200 dark:divide-gray-700">
                        <template x-for="khatian in displayedKhatians" :key="khatian.ID">
                            <li class="py-3 px-1 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition duration-150 ease-in-out">
                                <div class="flex items-center justify-between space-x-4">
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-semibold text-emerald-700 dark:text-emerald-400 truncate">
                                            খতিয়ান নং: <span class="font-mono" x-text="khatian.KHATIAN_NO"></span>
                                        </p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 truncate" title="মালিকের নাম">
                                            <i class="fas fa-user fa-fw mr-1 opacity-70"></i> <span x-html="khatian.Owners"></span>
                                        </p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 truncate font-mono mt-1" title="দাগ নম্বর">
                                            <i class="fas fa-thumbtack fa-fw mr-1 opacity-70"></i> <span x-text="khatian.DAGS"></span>
                                        </p>
                                    </div>
                                    <button @click="showKhatianDetails(khatian)"
                                            class="inline-flex items-center px-3 py-1 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition flex-shrink-0">
                                        বিস্তারিত <i class="fas fa-arrow-right ml-1 text-xs"></i>
                                    </button>
                                </div>
                            </li>
                        </template>
                    </ul>
                </div>
            </div> <?php // End Content Area ?>

            <?php // Pagination ?>
            <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700" x-show="!loadingKhatians && totalPages > 1">
                <nav class="flex items-center justify-between" aria-label="Pagination">
                    <div class="flex-1 flex justify-start">
                    <span class="text-sm text-gray-700 dark:text-gray-300 self-center">
                        পৃষ্ঠা <span x-text="currentPage"></span> / <span x-text="totalPages"></span>
                    </span>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button @click="fetchKhatians(currentPage - 1)" :disabled="currentPage <= 1 || loadingKhatians"
                                class="relative inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition">
                            <i class="fas fa-arrow-left mr-1 text-xs"></i> পূর্ববর্তী
                        </button>
                        <button @click="fetchKhatians(currentPage + 1)" :disabled="currentPage >= totalPages || loadingKhatians"
                                class="relative inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition">
                            পরবর্তী <i class="fas fa-arrow-right ml-1 text-xs"></i>
                        </button>
                    </div>
                </nav>
            </div> <?php // End Pagination ?>

        </div> <?php // End Results Panel ?>


        <?php // --- Khatian Details Modal --- ?>
        <div x-show="showKhatianModal"
             @keydown.escape.window="showKhatianModal = false"
             class="fixed inset-0 bg-black/70 dark:bg-black/80 flex items-center justify-center z-50 p-4"
             x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
             x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
             role="dialog" aria-modal="true" aria-labelledby="khatianModalTitle">

            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col"
                 @click.outside="showKhatianModal = false">
                <?php // Modal Header ?>
                <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
                    <h2 id="khatianModalTitle" class="text-lg font-semibold text-gray-800 dark:text-gray-200">
                        খতিয়ান বিবরণ (নং <span x-text="selectedKhatianDetail?.KHATIAN_NO"></span>)
                    </h2>
                    <button @click="showKhatianModal = false"
                            class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-2xl leading-none" aria-label="বন্ধ করুন">×</button>
                </div>
                <?php // Modal Body ?>
                <div class="p-5 overflow-y-auto flex-grow">
                    <div x-show="selectedKhatianDetail">
                        <dl class="grid grid-cols-[auto,1fr] gap-x-4 gap-y-3 text-sm">
                            <dt class="font-semibold text-gray-600 dark:text-gray-400 text-right pt-1">খতিয়ান নং:</dt>
                            <dd class="text-gray-800 dark:text-gray-200 font-mono font-bold pt-1" x-text="selectedKhatianDetail?.KHATIAN_NO"></dd>

                            <dt class="font-semibold text-gray-600 dark:text-gray-400 text-right pt-1">মালিক/গণ:</dt>
                            <dd class="text-gray-800 dark:text-gray-200 pt-1" x-html="selectedKhatianDetail?.formattedOwners"></dd>

                            <dt class="font-semibold text-gray-600 dark:text-gray-400 text-right pt-1 self-start">দাগ/সমূহ:</dt>
                            <dd class="text-gray-800 dark:text-gray-200 pt-1 font-mono text-xs whitespace-pre-wrap break-words bg-gray-50 dark:bg-gray-700 p-2 rounded border dark:border-gray-600" x-html="selectedKhatianDetail?.DAGS"></dd>

                            <dt class="font-semibold text-gray-600 dark:text-gray-400 text-right pt-1">মোট জমি:</dt>
                            <dd class="text-gray-800 dark:text-gray-200 pt-1" x-html="selectedKhatianDetail?.TOTAL_LAND"></dd>
                        </dl>
                    </div>
                    <div x-show="!selectedKhatianDetail" class="py-8 text-center text-gray-500 dark:text-gray-400">
                        <i class="fas fa-spinner fa-spin mr-2"></i> বিস্তারিত তথ্য লোড হচ্ছে...
                    </div>
                </div>
                <?php // Modal Footer ?>
                <div class="p-4 bg-gray-50 dark:bg-gray-700/50 border-t border-gray-200 dark:border-gray-700 text-right flex-shrink-0">
                    <button @click="showKhatianModal = false"
                            class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition">
                        বন্ধ করুন
                    </button>
                </div>
            </div>
        </div> <?php // End Modal ?>

    </div> <?php // End Container & Alpine Scope ?>

<?php // --- START Alpine JS logic for landSearchEnhanced --- ?>
    <script>
        // Set this via PHP or server config in a real application

    if (typeof window.API_BASE_URL === 'undefined') {
    // Provide a fallback if not set globally (adjust path as needed)
    window.API_BASE_URL = 'https://4bd.org/api/ajax.php'; // Or 'https://4bd.org/api/ajax.php' if needed
    console.warn("window.API_BASE_URL not set, using fallback:", window.API_BASE_URL);
    }

    if (typeof landSearchEnhanced !== 'function') {
    function landSearchEnhanced() {
    return {
    apiBaseUrl: window.API_BASE_URL, // Use the globally set or fallback URL
    // Data stores
    divisions: [], districts: [], upazilas: [], surveys: [], mouzas: [],
    allKhatiansForPage: [], // Raw data for current page from server
    khatianStore: {}, // Cache for modal details

    // Selected IDs/Values
    selectedDivision: '', selectedDistrict: '', selectedUpazila: '', selectedSurvey: '', selectedMouzaId: '',
    selectedDistrictBbsCode: '', selectedUpazilaBbsCode: '',

    // Search & Filter inputs
    mouzaSearchInput: '', // Filter for mouza list
    khatianSearch: '',    // Server search (Khatian No) - Sent to backend
    dagSearch: '',        // Server search (Dag No) - Sent to backend
    clientKhatianFilter: '', // Filter for currently displayed khatian list (client-side)

    // Loading states
    loadingDivisions: false, loadingDistricts: false, loadingUpazilas: false, loadingSurveys: false, loadingMouzas: false, loadingKhatians: false,

    // Pagination state
    currentPage: 1, totalPages: 0, totalKhatians: 0, pageSize: 2000, // Default page size

    // Error Handling
    errorMessage: '', errorMessageTimeout: null,

    // Modal State
    showKhatianModal: false, selectedKhatianDetailId: null,

    // --- Computed Properties ---
    get selectedKhatianDetail() {
    return this.selectedKhatianDetailId ? this.khatianStore[this.selectedKhatianDetailId] : null;
    },

    // Filter for Mouza List (Client-Side)
    get filteredMouzas() {
    if (!this.mouzaSearchInput) return this.mouzas;
    const searchTerm = this.mouzaSearchInput.toLowerCase().trim();
    if (!searchTerm) return this.mouzas; // Avoid filtering on just whitespace
    return this.mouzas.filter(m =>
    (m.mouza_name && m.mouza_name.toLowerCase().includes(searchTerm)) ||
    (m.jl_number && String(m.jl_number).includes(searchTerm)) // Match JL number as string contains
    );
    },

    // Filter for Displayed Khatian List (Client-Side)
    get displayedKhatians() {
    if (!this.clientKhatianFilter) return this.allKhatiansForPage;
    const searchTerm = this.clientKhatianFilter.toLowerCase().trim();
    if (!searchTerm) return this.allKhatiansForPage; // Avoid filtering on just whitespace

    // Function to safely check inclusion in potentially null/undefined strings
    const includesLower = (text, term) => text ? String(text).toLowerCase().includes(term) : false;

    return this.allKhatiansForPage.filter(k =>
    includesLower(k.KHATIAN_NO, searchTerm) ||
    includesLower(k.DAGS, searchTerm) ||
    includesLower(k.Owners, searchTerm) // Pre-formatted & escaped HTML
    // includesLower(k.OWNERS, searchTerm) // Optional: Search raw owners if needed, ensure safe rendering if used elsewhere
    );
    },

    // --- Reset Methods ---
    _resetDistricts() { this.districts = []; this.selectedDistrict = ''; this.selectedDistrictBbsCode = ''; this._resetUpazilas(); },
    _resetUpazilas() { this.upazilas = []; this.selectedUpazila = ''; this.selectedUpazilaBbsCode = ''; this._resetSurveys(); },
    _resetSurveys() { this.surveys = []; this.selectedSurvey = ''; this._resetMouzas(); },
    _resetMouzas() { this.mouzas = []; this.selectedMouzaId = ''; this.mouzaSearchInput = ''; this._resetKhatians(); },
    _resetKhatians() {
    this.allKhatiansForPage = []; this.khatianStore = {}; this.currentPage = 1;
    this.totalPages = 0; this.totalKhatians = 0; this.selectedKhatianDetailId = null;
    this.clientKhatianFilter = ''; // Reset client filter as server data is changing
    // Keep server search terms (khatianSearch, dagSearch) ? Optional, current behaviour keeps them.
    },

    // --- Error Handling ---
    _showError(message) {
    console.error("Land Search Error:", message);
    // Try to provide a more user-friendly generic message for common network issues
    let displayMessage = message || 'একটি অপ্রত্যাশিত ত্রুটি ঘটেছে।';
    if (message && message.toLowerCase().includes('failed to fetch')) {
    displayMessage = 'নেটওয়ার্ক সংযোগ সমস্যা। অনুগ্রহ করে আবার চেষ্টা করুন।';
    } else if (message && message.toLowerCase().includes('http error')) {
    displayMessage = 'সার্ভারের সাথে সংযোগ করতে সমস্যা হয়েছে।';
    }
    this.errorMessage = `ত্রুটি: ${displayMessage}`;
    if (this.errorMessageTimeout) clearTimeout(this.errorMessageTimeout);
    this.errorMessageTimeout = setTimeout(() => { this.errorMessage = ''; this.errorMessageTimeout = null; }, 8000); // Show for 8s
    },
    _clearError() {
    this.errorMessage = '';
    if (this.errorMessageTimeout) clearTimeout(this.errorMessageTimeout);
    },

    // --- Generic Data Fetching Function ---
    async _fetchData(endpoint, loadingVar) {
    // Ensure loadingVar is valid before setting it
    if (typeof this[loadingVar] === 'undefined') {
    console.error("Invalid loading variable used in _fetchData:", loadingVar);
    return null;
    }
    this[loadingVar] = true;
    this._clearError(); // Clear previous error

    const url = `${this.apiBaseUrl}?${endpoint}`;
    try {
    const response = await fetch(url, {
    // Optional: Add headers if needed, e.g., for authentication
    // headers: { 'Authorization': 'Bearer YOUR_TOKEN' }
    });
    if (!response.ok) {
    let errorBody = `HTTP ত্রুটি! Status: ${response.status} ${response.statusText}`;
    try {
    const errorJson = await response.json(); // Try to get more details from API response
    if (errorJson && errorJson.message) {
    // Use API's message if available and seems useful
    errorBody = String(errorJson.message).substring(0, 150); // Limit length
    }
    } catch (e) { /* Response wasn't JSON or failed parsing */ }
    throw new Error(errorBody);
    }
    const data = await response.json();
    if (!data || typeof data !== 'object') {
    throw new Error('API থেকে একটি অবৈধ প্রতিক্রিয়া প্রাপ্ত হয়েছে');
    }
    if (!data.success) {
    // Use the message from the API response if available
    throw new Error(data.message || 'অজানা এপিআই ত্রুটি (success: false)');
    }
    return data.data; // Return only the 'data' part on success
    } catch (error) {
    this._showError(error.message || 'Fetch operation failed');
    return null; // Indicate failure
    } finally {
    // Use $nextTick to ensure UI updates before potentially turning off loader
    this.$nextTick(() => {
    if (typeof this[loadingVar] !== 'undefined') {
    this[loadingVar] = false;
    }
    });
    }
    },

    // --- Selection & Fetch Handlers ---
    async fetchDivisions() {
    const d = await this._fetchData('action=get_divisions', 'loadingDivisions');
    if (d !== null) this.divisions = Array.isArray(d) ? d : [];
    },
    async fetchDistricts() {
    this._resetDistricts();
    if (!this.selectedDivision) return;
    const d = await this._fetchData(`action=get_districts&division_id=${this.selectedDivision}`, 'loadingDistricts');
    if (d !== null) this.districts = Array.isArray(d) ? d : [];
    },
    async fetchUpazilas() {
    this._resetUpazilas();
    if (!this.selectedDistrict) return;
    const selectedDistrictData = this.districts.find(dist => dist.id == this.selectedDistrict);
    this.selectedDistrictBbsCode = selectedDistrictData ? selectedDistrictData.bbs_code : '';
    if (!this.selectedDistrictBbsCode) { console.warn("District BBS code not found for ID:", this.selectedDistrict); return; }

    const d = await this._fetchData(`action=get_upazilas&district_id=${this.selectedDistrict}`, 'loadingUpazilas');
    if (d !== null) this.upazilas = Array.isArray(d) ? d : [];
    },
    async fetchSurveys() {
    this._resetSurveys();
    if (!this.selectedUpazila) return;
    const selectedUpazilaData = this.upazilas.find(upa => upa.id == this.selectedUpazila);
    this.selectedUpazilaBbsCode = selectedUpazilaData ? selectedUpazilaData.bbs_code : '';
    if (!this.selectedDistrictBbsCode || !this.selectedUpazilaBbsCode) { console.warn("Missing BBS code for survey fetch"); return; }

    const d = await this._fetchData(`action=get_surveys&district_bbs_code=${this.selectedDistrictBbsCode}&upazila_bbs_code=${this.selectedUpazilaBbsCode}`, 'loadingSurveys');
    if (d !== null) this.surveys = Array.isArray(d) ? d : [];
    },
    async fetchMouzas() {
    this._resetMouzas(); // This resets selectedMouzaId, mouzaSearchInput, and downstream khatians
    if (!this.selectedSurvey || !this.selectedDistrictBbsCode || !this.selectedUpazilaBbsCode) return;
    const d = await this._fetchData(`action=get_mouzas&district_bbs_code=${this.selectedDistrictBbsCode}&upazila_bbs_code=${this.selectedUpazilaBbsCode}&survey_id=${this.selectedSurvey}`, 'loadingMouzas');
    if (d !== null) this.mouzas = Array.isArray(d) ? d : [];
    },
    selectMouza(id) {
    if (this.selectedMouzaId != id) {
    this.selectedMouzaId = id;
    // Optional: Clear server search terms when changing mouza for less confusion?
    // this.khatianSearch = '';
    // this.dagSearch = '';
    this.fetchKhatians(1); // Fetch page 1 for the newly selected mouza
    // Optional: Scroll to results
    // this.$nextTick(() => document.getElementById('resultsPanel')?.scrollIntoView({ behavior: 'smooth', block: 'start' }));
    }
    },

    // --- Fetch Khatian Data (Handles Server Search implicitly via bound models) ---
    async fetchKhatians(page = 1) {
    if (!this.selectedMouzaId || !this.selectedSurvey) {
    this._resetKhatians(); // Clear results if selection is invalid
    return;
    }

    this.clientKhatianFilter = ''; // Clear client filter when fetching new server data
    this.allKhatiansForPage = []; // Clear previous page's display data immediately
    this.khatianStore = {};    // Clear cached details

    this.currentPage = Math.max(1, page); // Ensure page is valid
    let endpoint = `action=get_khatians&mouza_jl_id=${this.selectedMouzaId}&survey_id=${this.selectedSurvey}&page=${this.currentPage}&pageSize=${this.pageSize}`;

    // Append server search terms if they exist
    const khatianTerm = this.khatianSearch.trim();
    const dagTerm = this.dagSearch.trim();
    if (khatianTerm !== '') endpoint += `&khatian_search=${encodeURIComponent(khatianTerm)}`;
    if (dagTerm !== '') endpoint += `&dag_search=${encodeURIComponent(dagTerm)}`;

    // Fetch data (loading state handled within _fetchData)
    const data = await this._fetchData(endpoint, 'loadingKhatians');

    if (data !== null && typeof data === 'object') {
    // Check the structure returned by the API
    if (data.khatians !== undefined && data.totalItems !== undefined && Array.isArray(data.khatians)) {
    let tempStore = {};
    this.allKhatiansForPage = data.khatians.map(k => {
    if (!k || k.id == null) return null; // Skip potentially invalid entries
    // Map to consistent structure and pre-format
    const mappedKhatian = {
    ID: k.id, KHATIAN_NO: k.khatian_no || 'N/A',
    DAGS: k.dags || '-',
    OWNERS: k.owners || '-', // Raw data for potential future use
    GUARDIANS: k.guardians || '-', // Raw data
    TOTAL_LAND: k.total_land || '-',
    Owners: k.owners,
    formattedOwners: this.formatOwners(k.owners, k.guardians),
    formattedOwnersShort: this.formatOwners(k.owners, null, 1) // Limit to 1 for list view
    };
    tempStore[k.id] = mappedKhatian; // Cache details
    return mappedKhatian;
    }).filter(k => k !== null); // Remove any nulls from mapping invalid data

    this.khatianStore = tempStore;
    this.totalKhatians = data.totalItems || 0;
    this.totalPages = data.totalPages || 0;
    this.currentPage = data.currentPage || 1; // Use API's current page value

    } else {
    console.error("API response for khatians missing expected structure:", data);
    this._showError("খতিয়ান ডাটার ফরম্যাট সঠিক নয়।");
    this._resetKhatians(); // Reset state fully on bad data structure
    }
    } else if (!this.errorMessage) {
    // _fetchData returned null, but didn't set an error message (e.g., silent failure?)
    console.error("API did not return valid data object for khatians, and no error was explicitly set.");
    // Don't necessarily show error here as _fetchData might have already shown one
    this._resetKhatians(); // Reset state
    } else {
    // Error occurred, message already shown by _fetchData, just ensure reset
    this._resetKhatians();
    }
    },

    // --- Trigger Server Search ---
    // Called by @input on khatian/dag search fields after debounce
    triggerServerSearch() {
    if (this.selectedMouzaId) {
    this.fetchKhatians(1); // Always fetch page 1 when search terms change via typing
    }
    },
    // Called by explicit button click or Enter key press
    searchKhatiansNow() {
    if (this.selectedMouzaId) {
    this.fetchKhatians(1); // Always search page 1 explicitly
    }
    },

    // --- Show Khatian Details Modal ---
    showKhatianDetails(khatian) {
    if (khatian && khatian.ID && this.khatianStore[khatian.ID]) {
    this.selectedKhatianDetailId = khatian.ID; // Set the ID to lookup in the store
    this.showKhatianModal = true;
    } else {
    console.warn("Details not found in store for khatian:", khatian);
    this._showError("বিস্তারিত তথ্য দেখাতে সমস্যা হয়েছে।");
    }
    },

    // --- Format Owners/Guardians for Display ---
    formatOwners(owners, guardians, limit = null) {
    // Basic HTML escaping function
    const escapeHtml = (unsafe) => {
    if (typeof unsafe !== 'string') return '';
    return unsafe.replace(/&/g, "&").replace(/</g, "<").replace(/>/g, ">").replace(/"/g, "\"").replace(/'/g, "'");
    };

    const ownersString = owners != null ? String(owners) : '';
    const guardiansString = guardians != null ? String(guardians) : '';

    let ownerList = ownersString.trim() ? ownersString.split(',').map(o => escapeHtml(o.trim())).filter(o => o) : []; // Split, trim, escape, filter empty
    let suffix = '';

    // Handle case where there are no valid owners after processing
    if(ownerList.length === 0) ownerList = ['-'];

    // Apply limit if specified (for short list view)
    if (limit !== null && ownerList.length > limit) {
    ownerList = ownerList.slice(0, limit);
    suffix = ' ...';
    }

    // Join owners with <br> for modal (full view) or ', ' for short list view
    let ownerHtml = ownerList.join(limit === null ? '<br>' : ', ') + suffix;

    // Add guardian info only in the full view (modal, limit === null)
    if (limit === null && guardiansString && guardiansString !== '0' && guardiansString.trim() !== '') {
    const guardianList = guardiansString.split(',').map(g => escapeHtml(g.trim())).filter(g => g); // Split, trim, escape, filter empty
    if(guardianList.length > 0) {
    // Add a visual separation and clear indication
    ownerHtml += `<br><span class='mt-1.5 block text-xs text-gray-500 dark:text-gray-400 border-t dark:border-gray-600 pt-1.5'><strong>অভিভাবক:</strong><br>${guardianList.join('<br>')}</span>`;
    }
    }
    return ownerHtml || '-'; // Ensure we always return something, fallback to '-'
    }

    }; // End return object for Alpine data
    } // End landSearchEnhanced function
    } // End if typeof check
    </script>
<?php // --- END Alpine JS logic --- ?>
# api/ajax.php
<?php

// --- CORS Configuration ---
// IMPORTANT: In production, replace '*' with your specific frontend domain(s)
$allowed_origins = ['*']; // Example: ['https://yourdomain.com', 'https://www.yourdomain.com']
$origin = $_SERVER['HTTP_ORIGIN'] ?? '';

if (in_array('*', $allowed_origins) || in_array($origin, $allowed_origins)) {
    header('Access-Control-Allow-Origin: ' . ($origin ?: '*')); // Send back specific origin if matched, or '*' if allowed
    header('Access-Control-Allow-Methods: GET, POST, OPTIONS');
    header('Access-Control-Allow-Headers: Content-Type, Authorization'); // Add any other headers your frontend sends
    // header('Access-Control-Allow-Credentials: true'); // Uncomment if you use cookies/sessions
}

// Handle OPTIONS preflight request (sent before POST/GET with custom headers/credentials)
if ($_SERVER['REQUEST_METHOD'] == 'OPTIONS') {
    // CORS headers already sent above if origin is allowed
    http_response_code(204); // No Content
    exit();
}

// --- JSON Response Header ---
// Set AFTER handling CORS/OPTIONS to avoid issues
header('Content-Type: application/json; charset=utf-8');

// --- Database Connection ---
// CRITICAL SECURITY: Use environment variables or a secure config file OUTSIDE web root.
// Example using environment variables (requires a library like phpdotenv):
// require 'vendor/autoload.php';
// $dotenv = Dotenv\Dotenv::createImmutable(__DIR__); // Adjust path as needed
// $dotenv->safeLoad(); // Use safeLoad to avoid errors if .env is missing
// $host = $_ENV['DB_HOST'] ?? "172.188.89.41"; // Fallback only for example
// $username = $_ENV['DB_USER'] ?? "bdland";
// $password = $_ENV['DB_PASS'] ?? "8WF7LLRWHALsFjinvFU4";
// $database = $_ENV['DB_NAME'] ?? "bdland";

// --- !! TEMPORARY HARDCODED CREDENTIALS (REPLACE ASAP) !! ---
$host = "172.188.89.41";
$username = "bdland";
$password = "8WF7LLRWHALsFjinvFU4";
$database = "bdland";
$mysqli = new mysqli($host, $username, $password, $database);

// Check connection
if ($mysqli->connect_errno) {
    error_log("Database connection failed: (" . $mysqli->connect_errno . ") " . $mysqli->connect_error);
    echo json_encode(['success' => false, 'message' => "Database connection error. Please try again later."]); // User-friendly message
    exit();
}

// Set charset AFTER connection
if (!$mysqli->set_charset('utf8mb4')) {
    error_log("Error loading character set utf8mb4: " . $mysqli->error);
    echo json_encode(['success' => false, 'message' => "Database character set error."]);
    $mysqli->close();
    exit();
}
// --- End Database Connection ---

// Consider moving this to a database table or a config file
$SURVEY_types = [
    1 => ['সি এস', 'CS', 4],
    2 => ['আর এস', 'RS', 1],
    3 => ['এস এ', 'SA', 3],
    4 => ['বি এস', 'BS', 2],
    5 => ['দিয়ারা', 'DIARA', 3],
    6 => ['পেটি', 'PETY', 4],
    7 => ['বি আর এস', 'BRS', 2],
    8 => ['বি ডি এস', 'BDS', 6],
];

$action = $_REQUEST['action'] ?? null;
$response = ['success' => false, 'message' => 'Invalid action specified', 'data' => []];

try { // Wrap main logic

    switch ($action) {
        // --- Get Divisions ---
        case 'get_divisions':
            $result = $mysqli->query("SELECT id, name, name_en FROM dlrms_divisions WHERE row_status = 1 ORDER BY name_en");
            if ($result) {
                $response['data'] = $result->fetch_all(MYSQLI_ASSOC);
                $response['success'] = true;
                $response['message'] = 'Divisions fetched successfully';
            } else {
                $response['message'] = 'Error fetching divisions: ' . $mysqli->error;
            }
            break;

        // --- Get Districts ---
        case 'get_districts':
            $division_id = filter_input(INPUT_GET, 'division_id', FILTER_VALIDATE_INT);
            if (!$division_id) {
                $response['message'] = 'Invalid or missing Division ID';
                break;
            }
            $stmt = $mysqli->prepare("SELECT id, name, name_en, bbs_code FROM dlrms_districts WHERE division_id = ? AND row_status = 1 ORDER BY name_en");
            if ($stmt) {
                $stmt->bind_param("i", $division_id);
                if ($stmt->execute()) {
                    $result = $stmt->get_result();
                    $response['data'] = $result->fetch_all(MYSQLI_ASSOC);
                    $response['success'] = true;
                    $response['message'] = 'Districts fetched successfully';
                } else {
                    $response['message'] = 'Error executing district query: ' . $stmt->error;
                }
                $stmt->close();
            } else {
                $response['message'] = 'Error preparing district query: ' . $mysqli->error;
            }
            break;

        // --- Get Upazilas/Circles ---
        case 'get_upazilas':
            $district_id = filter_input(INPUT_GET, 'district_id', FILTER_VALIDATE_INT);
            if (!$district_id) {
                $response['message'] = 'Invalid or missing District ID';
                break;
            }
            $stmt = $mysqli->prepare("SELECT id, name, name_en, bbs_code, is_circle FROM dlrms_upazilas WHERE district_id = ? AND row_status = 1 ORDER BY name");
            if ($stmt) {
                $stmt->bind_param("i", $district_id);
                if ($stmt->execute()) {
                    $result = $stmt->get_result();
                    $response['data'] = $result->fetch_all(MYSQLI_ASSOC);
                    $response['success'] = true;
                    $response['message'] = 'Upazilas fetched successfully';
                } else {
                    $response['message'] = 'Error executing upazila query: ' . $stmt->error;
                }
                $stmt->close();
            } else {
                $response['message'] = 'Error preparing upazila query: ' . $mysqli->error;
            }
            break;

        // --- Get Surveys Available ---
        case 'get_surveys':
            $district_bbs_code = filter_input(INPUT_GET, 'district_bbs_code', FILTER_SANITIZE_STRING);
            $upazila_bbs_code = filter_input(INPUT_GET, 'upazila_bbs_code', FILTER_SANITIZE_STRING);
            if (empty($district_bbs_code) || empty($upazila_bbs_code)) {
                $response['message'] = 'Invalid or missing BBS codes';
                break;
            }
            // Assuming dlrms_surveys contains the needed info (id, name, order)
            // And dlrms_mouza_jl_numbers links surveys to locations
            $stmt = $mysqli->prepare("
                SELECT DISTINCT s.survey_id, s.local_name, s.survey_order
                FROM dlrms_surveys s
                JOIN dlrms_mouza_jl_numbers mj ON s.survey_id = mj.survey_id
                WHERE mj.district_bbs_code = ? AND mj.upazila_bbs_code = ?
                -- AND s.row_status = 1 -- If surveys table has a status flag
                ORDER BY s.survey_order, s.local_name
             ");
            if ($stmt) {
                $stmt->bind_param("ss", $district_bbs_code, $upazila_bbs_code);
                if ($stmt->execute()) {
                    $result = $stmt->get_result();
                    $response['data'] = $result->fetch_all(MYSQLI_ASSOC);
                    $response['success'] = true;
                    $response['message'] = 'Available surveys fetched successfully';
                } else {
                    $response['message'] = 'Error executing survey query: ' . $stmt->error;
                }
                $stmt->close();
            } else {
                $response['message'] = 'Error preparing survey query: ' . $mysqli->error;
            }
            break;

        // --- Get Mouzas/JL Numbers ---
        case 'get_mouzas':
            $district_bbs_code = filter_input(INPUT_GET, 'district_bbs_code', FILTER_SANITIZE_STRING);
            $upazila_bbs_code = filter_input(INPUT_GET, 'upazila_bbs_code', FILTER_SANITIZE_STRING);
            $survey_id = filter_input(INPUT_GET, 'survey_id', FILTER_VALIDATE_INT);
            if (empty($district_bbs_code) || empty($upazila_bbs_code) || empty($survey_id)) {
                $response['message'] = 'Invalid or missing parameters for mouza';
                break;
            }
            // Validate Survey ID exists in our config/DB before using it if needed elsewhere
            if (!isset($SURVEY_types[$survey_id])) {
                $response['message'] = 'Invalid Survey ID provided for Mouza lookup';
                break;
            }

            $stmt = $mysqli->prepare("
                SELECT id, mouza_name, jl_number
                FROM dlrms_mouza_jl_numbers
                WHERE district_bbs_code = ? AND upazila_bbs_code = ? AND survey_id = ?
                -- AND row_status = 1 -- If mouza table has a status flag
                ORDER BY CAST(jl_number AS UNSIGNED), jl_number, mouza_name
             ");
            if ($stmt) {
                $stmt->bind_param("ssi", $district_bbs_code, $upazila_bbs_code, $survey_id);
                if ($stmt->execute()) {
                    $result = $stmt->get_result();
                    $response['data'] = $result->fetch_all(MYSQLI_ASSOC);
                    $response['success'] = true;
                    $response['message'] = 'Mouzas fetched successfully';
                } else {
                    $response['message'] = 'Error executing mouza query: ' . $stmt->error;
                }
                $stmt->close();
            } else {
                $response['message'] = 'Error preparing mouza query: ' . $mysqli->error;
            }
            break;

        // --- Get Khatians (Pagination, Server Search) ---
        case 'get_khatians':
            $mouza_jl_id = filter_input(INPUT_GET, 'mouza_jl_id', FILTER_VALIDATE_INT);
            $survey_id = filter_input(INPUT_GET, 'survey_id', FILTER_VALIDATE_INT);

            // Validate Survey ID and get table suffix
            if (!isset($SURVEY_types[$survey_id])) {
                $response['message'] = 'Invalid or unsupported Survey ID';
                break;
            }
            $survey_name = $SURVEY_types[$survey_id][1]; // Get 'CS', 'RS' etc.

            $page = filter_input(INPUT_GET, 'page', FILTER_VALIDATE_INT, ['options' => ['default' => 1, 'min_range' => 1]]);
            $pageSize = filter_input(INPUT_GET, 'pageSize', FILTER_VALIDATE_INT, ['options' => ['default' => 2000, 'min_range' => 1, 'max_range' => 2000]]); // Max page size limit
            $khatian_search = filter_input(INPUT_GET, 'khatian_search', FILTER_SANITIZE_STRING);
            $dag_search = filter_input(INPUT_GET, 'dag_search', FILTER_SANITIZE_STRING);

            $khatian_search_term = (!empty($khatian_search)) ? "%" . $mysqli->real_escape_string(trim($khatian_search)) . "%" : null;
            $dag_search_term = (!empty($dag_search)) ? "%" . $mysqli->real_escape_string(trim($dag_search)) . "%" : null;

            $responseDataTemplate = [
                'khatians' => [], 'totalItems' => 0, 'totalPages' => 0, 'currentPage' => $page, 'pageSize' => $pageSize
            ];
            $response['data'] = $responseDataTemplate; // Initialize data structure

            if (!$mouza_jl_id) {
                $response['message'] = 'Invalid or missing Mouza/JL ID';
                break;
            }

            $offset = ($page - 1) * $pageSize;
            $totalItems = 0;
            $totalPages = 0;

            // --- Build Dynamic WHERE Clause and Params ---
            // Base condition
            $whereClause = "jl_number_id = ?";
            $params = [$mouza_jl_id];
            $types = "i";

            // Add search conditions
            if ($khatian_search_term !== null) {
                $whereClause .= " AND khatian_no LIKE ?";
                $params[] = $khatian_search_term;
                $types .= "s";
            }
            if ($dag_search_term !== null) {
                // WARNING: LIKE on comma-separated values is inefficient.
                // Consider schema normalization or FULLTEXT index for performance.
                $whereClause .= " AND dags LIKE ?";
                $params[] = $dag_search_term;
                $types .= "s";
            }

            // --- Get total count ---
            $countSql = "SELECT COUNT(*) as total FROM dlrms_khatians_{$survey_name} WHERE " . $whereClause;
            $countStmt = $mysqli->prepare($countSql);

            if ($countStmt) {
                // Bind params only if there are any (jl_number_id is always present)
                $countStmt->bind_param($types, ...$params);

                if ($countStmt->execute()) {
                    $countResult = $countStmt->get_result();
                    $totalItems = (int) $countResult->fetch_assoc()['total'];
                    $totalPages = $totalItems > 0 ? ceil($totalItems / $pageSize) : 0;
                    // Update response data with counts
                    $response['data']['totalItems'] = $totalItems;
                    $response['data']['totalPages'] = $totalPages;
                } else {
                    $response['message'] = 'Error executing count query: ' . $countStmt->error;
                    $countStmt->close();
                    break; // Stop processing this case
                }
                $countStmt->close();
            } else {
                $response['message'] = 'Error preparing count query: ' . $mysqli->error . ' SQL: ' . $countSql;
                break; // Stop processing this case
            }
            // --- End count ---

            // --- Get paginated data ---
            if ($totalItems > 0 && $offset < $totalItems) {
                // Prepare params for data query (add LIMIT and OFFSET)
                $dataParams = $params; // Start with search params
                $dataParams[] = $pageSize;
                $dataParams[] = $offset;
                $dataTypes = $types . "ii"; // Add types for LIMIT and OFFSET

                $dataSql = "SELECT id, jl_number_id, mouza_id, khatian_no, office_id, khatian_entry_id, dags, owners, guardians, total_land
                             FROM dlrms_khatians_{$survey_name}
                             WHERE " . $whereClause . "
                             ORDER BY CAST(khatian_no AS UNSIGNED), khatian_no, id
                             LIMIT ? OFFSET ?";
                $stmt = $mysqli->prepare($dataSql);

                if ($stmt) {
                    $stmt->bind_param($dataTypes, ...$dataParams);

                    if ($stmt->execute()) {
                        $result = $stmt->get_result();
                        $fetched_khatians = $result->fetch_all(MYSQLI_ASSOC);

                        // Basic validation/filtering (optional, ideally handled by DB constraints)
                        $valid_khatians = array_filter($fetched_khatians, function($k) {
                            return isset($k['id']) && $k['id'] !== null && $k['id'] !== '';
                        });

                        $response['data']['khatians'] = array_values($valid_khatians); // Re-index array
                        $response['success'] = true;
                        $response['message'] = 'Khatians fetched successfully';

                    } else {
                        $response['message'] = 'Error executing khatian query: ' . $stmt->error;
                    }
                    $stmt->close();
                } else {
                    $response['message'] = 'Error preparing khatian query: ' . $mysqli->error . ' SQL: ' . $dataSql;
                }
            } else {
                // Handle cases where totalItems is 0 or page is out of bounds based on search
                $searchActive = ($khatian_search_term !== null || $dag_search_term !== null);
                $response['success'] = true; // Not an error, just no data for this page/search
                $response['message'] = $totalItems === 0
                    ? ($searchActive ? 'আপনার অনুসন্ধানে কোন খতিয়ান পাওয়া যায়নি।' : 'এই মৌজার জন্য কোন খতিয়ান পাওয়া যায়নি।')
                    : 'Khatians fetched successfully (empty page)';
                // data['khatians'] is already []
            }
            break; // End case 'get_khatians'

        // --- Default Case ---
        default:
            // Keep default error message: 'Invalid action specified'
            $response['data'] = []; // Ensure data is empty
            break;
    }

} catch (mysqli_sql_exception $e) {
    error_log("Database Error: " . $e->getMessage() . " (Code: " . $e->getCode() . ")");
    $response['success'] = false;
    $response['message'] = 'A database error occurred. Please check logs.';
    $response['data'] = [];
} catch (Exception $e) {
    error_log("General Error in ajax.php: " . $e->getMessage() . "\n" . $e->getTraceAsString());
    $response['success'] = false;
    $response['message'] = 'An unexpected server error occurred.';
    $response['data'] = [];
}

// Close the connection if it's still open
if ($mysqli instanceof mysqli && $mysqli->thread_id) {
    $mysqli->close();
}


// Send the JSON response
echo json_encode($response, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
exit();

?>
# tools/search-namjari.php
<?php
// This file is included by the main tools.php
// It assumes $selected_tool (array from DB) is available.

// PHP survey data
$SURVEY_types_php = [
    1 => ['সি এস', 'CS', 4], 2 => ['আর এস', 'RS', 1], 3 => ['এস এ', 'SA', 3],
    4 => ['বি এস', 'BS', 2], 5 => ['দিয়ারা', 'DIARA', 3], 6 => ['পেটি', 'PETY', 4],
    7 => ['বি আর এস', 'BRS', 2], 8 => ['বি ডি এস', 'BDS', 6],
];
uasort($SURVEY_types_php, function ($a, $b) { return ($a[2] ?? 99) <=> ($b[2] ?? 99); });

// --- Get initial values from $_GET ---
$initial_survey_id = isset($_GET['survey_id']) ? filter_input(INPUT_GET, 'survey_id', FILTER_SANITIZE_NUMBER_INT) : '';
$initial_owner = isset($_GET['owner']) ? trim(filter_input(INPUT_GET, 'owner', FILTER_SANITIZE_FULL_SPECIAL_CHARS)) : '';
$initial_guardian = isset($_GET['guardian']) ? trim(filter_input(INPUT_GET, 'guardian', FILTER_SANITIZE_FULL_SPECIAL_CHARS)) : '';
$initial_page = isset($_GET['page']) ? filter_input(INPUT_GET, 'page', FILTER_SANITIZE_NUMBER_INT) : 1;
$initial_page = max(1, (int)$initial_page);
$triggerSearch = !empty($initial_survey_id) && (!empty($initial_owner) || !empty($initial_guardian));

// Define BASE_URL constant if not already defined globally
if (!defined('BASE_URL')) {
    $protocol = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off' || $_SERVER['SERVER_PORT'] == 443) ? "https" : "http";
    $host = $_SERVER['HTTP_HOST'];
    $base_path = (dirname($_SERVER['SCRIPT_NAME']) === '/' || dirname($_SERVER['SCRIPT_NAME']) === '\\') ? '' : dirname($_SERVER['SCRIPT_NAME']);
    if (str_ends_with($base_path, '/tools')) { $base_path = dirname($base_path); if ($base_path === '\\') $base_path = ''; }
    define('BASE_URL', $protocol . '://' . $host . ($base_path === '/' ? '' : $base_path) );
}
$base_url_js = BASE_URL;

?>

<?php /* --- Minimal CSS for Mobile Table Labels --- */ ?>
    <style>
        [x-cloak] { display: none !important; }
        @media (max-width: 767px) {
            #namjari-khatian-results-tbody > tr > td[data-label]::before {
                content: attr(data-label); position: absolute; left: 0.75rem; top: 0.6rem;
                padding-right: 0.5rem; text-align: left; font-weight: 600; font-size: 0.75rem;
                color: #4b5563; white-space: nowrap;
            }
            .dark #namjari-khatian-results-tbody > tr > td[data-label]::before { color: #9ca3af; }
        }
    </style>

    <div class="container mx-auto px-3 py-4 md:px-4 md:py-6 max-w-6xl"
         x-data="namjariSearch()" x-init="init()" x-cloak>

        <!-- Header -->
        <div class="flex justify-between items-center mb-5 md:mb-6">
            <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-emerald-700 dark:text-emerald-400">নামজারি খতিয়ানের তথ্য</h1>
        </div>

        <!-- Error Message Area -->
        <div x-show="errorMessage" x-transition class="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-md dark:bg-red-900/50 dark:border-red-700/50 dark:text-red-300" role="alert">
            <div class="flex justify-between items-center">
                <span><i class="fas fa-exclamation-triangle mr-2"></i> <span x-text="errorMessage"></span></span>
                <button @click="errorMessage = ''" class="font-bold text-red-700 dark:text-red-300 ml-2 opacity-70 hover:opacity-100">×</button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex flex-col lg:flex-row lg:space-x-6 space-y-6 lg:space-y-0">

            <!-- Left Column: Selections -->
            <div class="w-full lg:w-1/3 space-y-4 flex flex-col">
                <?php // Division, District, Upazila, Mouza sections ... (HTML remains the same) ... ?>
                <!-- Division Section -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 overflow-hidden flex-shrink-0">
                    <div class="px-4 py-2 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600 text-sm font-semibold text-gray-700 dark:text-gray-300">বিভাগ</div>
                    <div class="p-3"><div class="relative">
                            <select id="division" name="division_bbs" x-model="selectedDivisionBbs" @change="fetchDistricts()" :disabled="loadingDivisions" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 disabled:bg-gray-200 dark:disabled:bg-gray-600 disabled:cursor-not-allowed appearance-none pr-8 text-sm">
                                <option value="">-- নির্বাচন করুন --</option>
                                <template x-if="!loadingDivisions && Array.isArray(divisions)"><template x-for="division in divisions" :key="division.bbs_code"><option :value="division.bbs_code" x-text="division.name"></option></template></template>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-400"><i x-show="loadingDivisions" class="fas fa-spinner fa-spin text-sm animate-spin"></i><i x-show="!loadingDivisions" class="fas fa-chevron-down text-xs"></i></div>
                        </div></div>
                </div>
                <!-- District Section -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 overflow-hidden flex-shrink-0" :class="{ 'opacity-50': !selectedDivisionBbs }">
                    <div class="px-4 py-2 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600 text-sm font-semibold text-gray-700 dark:text-gray-300">জেলা</div>
                    <div class="p-3"><div class="relative">
                            <select id="district" name="district_bbs" x-model="selectedDistrictBbs" @change="fetchUpazilas()" :disabled="!selectedDivisionBbs || loadingDistricts" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 disabled:bg-gray-200 dark:disabled:bg-gray-600 disabled:cursor-not-allowed appearance-none pr-8 text-sm">
                                <option value="">-- নির্বাচন করুন --</option>
                                <template x-if="!loadingDistricts && Array.isArray(districts)"><template x-for="district in districts" :key="district.bbs_code"><option :value="district.bbs_code" x-text="district.name"></option></template></template>
                                <template x-if="selectedDivisionBbs && !loadingDistricts && Array.isArray(districts) && districts.length === 0"><option value="" disabled>কোনো জেলা পাওয়া যায়নি</option></template>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-400"><i x-show="loadingDistricts" class="fas fa-spinner fa-spin text-sm animate-spin"></i><i x-show="!loadingDistricts && selectedDivisionBbs" class="fas fa-chevron-down text-xs"></i></div>
                        </div></div>
                </div>
                <!-- Upazila Section -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 overflow-hidden flex-shrink-0" :class="{ 'opacity-50': !selectedDistrictBbs }">
                    <div class="px-4 py-2 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600 text-sm font-semibold text-gray-700 dark:text-gray-300">উপজেলা/থানা</div>
                    <div class="p-3"><div class="relative">
                            <select id="upazila" name="upazila_bbs" x-model="selectedUpazilaBbs" @change="fetchMouzas()" :disabled="!selectedDistrictBbs || loadingUpazilas" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 disabled:bg-gray-200 dark:disabled:bg-gray-600 disabled:cursor-not-allowed appearance-none pr-8 text-sm">
                                <option value="">-- নির্বাচন করুন --</option>
                                <template x-if="!loadingUpazilas && Array.isArray(upazilas)"><template x-for="upazila in upazilas" :key="upazila.bbs_code"><option :value="upazila.bbs_code" x-text="upazila.name"></option></template></template>
                                <template x-if="selectedDistrictBbs && !loadingUpazilas && Array.isArray(upazilas) && upazilas.length === 0"><option value="" disabled>কোনো উপজেলা পাওয়া যায়নি</option></template>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-400"><i x-show="loadingUpazilas" class="fas fa-spinner fa-spin text-sm animate-spin"></i><i x-show="!loadingUpazilas && selectedDistrictBbs" class="fas fa-chevron-down text-xs"></i></div>
                        </div></div>
                </div>
                <!-- Mouza Section -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 overflow-hidden flex flex-col flex-grow" :class="{ 'opacity-50': !selectedUpazilaBbs }">
                    <div class="px-4 py-2 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600 text-sm font-semibold text-gray-700 dark:text-gray-300 flex-shrink-0">মৌজা</div>
                    <div class="relative border-b border-gray-200 dark:border-gray-600 flex-shrink-0">
                        <input type="search" id="mouza_search" x-model="mouzaSearch" placeholder="মৌজা খুঁজুন (জেএল বা নাম)" :disabled="!selectedUpazilaBbs || loadingMouzas" @input.debounce.300ms="filterMouzas()" class="w-full pl-8 pr-8 py-2 border-0 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:ring-0 focus:border-emerald-500 dark:focus:border-emerald-500 placeholder-gray-400 dark:placeholder-gray-500 text-sm" autocomplete="off">
                        <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none text-gray-400 dark:text-gray-500"><i class="fas fa-search text-xs"></i></div>
                        <div class="absolute inset-y-0 right-0 pr-2 flex items-center pointer-events-none text-gray-400 dark:text-gray-500"><i x-show="loadingMouzas" class="fas fa-spinner fa-spin animate-spin text-sm"></i></div>
                    </div>
                    <div class="overflow-y-auto flex-grow">
                        <div x-show="selectedUpazilaBbs && !loadingMouzas">
                            <template x-if="Array.isArray(filteredMouzas)">
                                <template x-for="mouza in filteredMouzas" :key="mouza.id">
                                    <div @click="selectMouza(mouza)" class="px-3 py-2 border-b border-gray-100 dark:border-gray-700 cursor-pointer text-sm hover:bg-emerald-50 dark:hover:bg-gray-700 text-gray-800 dark:text-gray-300" :class="{ 'bg-emerald-600 text-white dark:bg-emerald-700': selectedMouza && selectedMouza.id === mouza.id }"><span x-text="mouza.name"></span></div>
                                </template>
                            </template>
                            <div x-show="Array.isArray(filteredMouzas) && filteredMouzas.length === 0 && mouzaSearch" class="px-3 py-4 text-center text-gray-500 dark:text-gray-400 italic text-sm">কোনো মৌজা পাওয়া যায়নি।</div>
                            <div x-show="Array.isArray(mouzas) && mouzas.length === 0 && !mouzaSearch" class="px-3 py-4 text-center text-gray-500 dark:text-gray-400 italic text-sm">এই উপজেলার জন্য কোন মৌজা লোড হয়নি।</div>
                        </div>
                        <div x-show="loadingMouzas" class="px-3 py-4 text-center text-gray-500 dark:text-gray-400 text-sm"><i class="fas fa-spinner fa-spin mr-1"></i> লোড হচ্ছে...</div>
                    </div>
                </div>
            </div> <!-- End Left Column -->

            <!-- Right Column: Khatian List -->
            <div class="w-full lg:w-2/3">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 overflow-hidden flex flex-col h-full" :class="{ 'opacity-50': !selectedMouza }">
                    <div class="px-4 py-2 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600 flex justify-between items-center flex-shrink-0">
                        <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">খতিয়ানের তালিকা: <span class="font-semibold text-emerald-700 dark:text-emerald-400" x-text="selectedMouza ? selectedMouza.name : ' (মৌজা নির্বাচন করুন)'"></span></span>
                        <i x-show="loadingKhatians" class="fas fa-spinner fa-spin animate-spin text-sm text-gray-500 dark:text-gray-400"></i>
                    </div>
                    <div class="relative border-b border-gray-200 dark:border-gray-600 flex-shrink-0">
                        <label for="khatian_search" class="sr-only">খতিয়ান অনুসন্ধান</label>
                        <!-- **** MODIFIED PLACEHOLDER **** -->
                        <input type="search" id="khatian_search" x-model="khatianSearch" placeholder="খতিয়ান খুঁজুন (নম্বর, মালিক বা দাগ)" @input.debounce.300ms="filterKhatians()" :disabled="!selectedMouza || loadingKhatians" class="w-full pl-8 pr-3 py-2 border-0 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:ring-0 focus:border-emerald-500 dark:focus:border-emerald-500 placeholder-gray-400 dark:placeholder-gray-500 text-sm" autocomplete="off">
                        <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none text-gray-400 dark:text-gray-500"><i class="fas fa-search text-xs"></i></div>
                    </div>
                    <div class="overflow-auto flex-grow">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0 z-10">
                            <tr>
                                <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">খতিয়ান নং</th>
                                <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">মালিকের নাম</th>
                                <th scope="col" class="px-4 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">মোট জমি</th>
                                <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">দাগ নং</th>
                            </tr>
                            </thead>
                            <tbody id="namjari-khatian-results-tbody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-600">
                            <template x-if="loadingKhatians">
                                <tr><td colspan="4" class="px-4 py-10 text-center text-gray-500 dark:text-gray-400"><i class="fas fa-spinner fa-spin fa-lg animate-spin"></i><p class="mt-2 text-sm">লোড হচ্ছে...</p></td></tr>
                            </template>
                            <template x-if="!selectedMouza && !loadingKhatians">
                                <tr><td colspan="4" class="px-4 py-6 text-center text-gray-400 dark:text-gray-500 italic text-sm">বাম পাশ থেকে মৌজা নির্বাচন করুন</td></tr>
                            </template>
                            <template x-if="selectedMouza && !loadingKhatians && Array.isArray(filteredKhatians) && filteredKhatians.length === 0">
                                <tr><td colspan="4" class="px-4 py-6 text-center text-gray-500 dark:text-gray-400 italic"><span x-show="khatianSearch">অনুসন্ধানের সাথে মেলে এমন কোনো খতিয়ান পাওয়া যায়নি।</span><span x-show="!khatianSearch">এই মৌজার জন্য কোনো খতিয়ান পাওয়া যায়নি।</span></td></tr>
                            </template>
                            <template x-if="!loadingKhatians && Array.isArray(filteredKhatians)">
                                <template x-for="khatian in filteredKhatians" :key="khatian.id">
                                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-150 text-sm">
                                        <td data-label="খতিয়ান নং" class="px-4 py-2 whitespace-nowrap font-medium text-gray-900 dark:text-gray-100"
                                            x-html="generateKhatianLinkHtml(khatian, selectedDistrictBbs, selectedUpazilaBbs, khatian.mouza_id, khatian.survey_type)">
                                        </td>
                                        <td data-label="মালিকের নাম" class="px-4 py-2 text-gray-700 dark:text-gray-300" x-text="khatian.owners || '-'"></td>
                                        <td data-label="মোট জমি" class="px-4 py-2 whitespace-nowrap text-gray-600 dark:text-gray-400 text-right" x-text="khatian.total_land !== null && khatian.total_land !== undefined ? Number(khatian.total_land).toFixed(4) : '-'"></td>
                                        <td data-label="দাগ নং" class="px-4 py-2 text-gray-600 dark:text-gray-400">
                                            <span x-html="generateDagLinksHtml(khatian.dags, selectedDistrictBbs, selectedUpazilaBbs, selectedMouza?.id, khatian.mouza_id, khatian.survey_type)"></span>
                                        </td>
                                    </tr>
                                </template>
                            </template>
                            </tbody>
                        </table>
                    </div> <!-- End Table Overflow -->
                </div> <!-- End Khatian Section -->
            </div> <!-- End Right Column -->

        </div> <!-- End Main Flex Container -->
    </div> <!-- end container -->

    <!-- Alpine.js Component Logic -->
    <script>
        const API_URL_NAMJARI = 'https://4bd.org/api/namjari-khatian-ajax.php';

        if (typeof namjariSearch !== 'function') {
            function namjariSearch() {
                return {
                    // --- State ---
                    divisions: [], districts: [], upazilas: [], mouzas: [], khatians: [],
                    filteredMouzas: [], filteredKhatians: [],
                    selectedDivisionBbs: '', selectedDistrictBbs: '', selectedUpazilaBbs: '', selectedMouza: null,
                    mouzaSearch: '', khatianSearch: '',
                    loadingDivisions: false, loadingDistricts: false, loadingUpazilas: false, loadingMouzas: false, loadingKhatians: false,
                    errorMessage: '',
                    phpBaseUrl: '<?= $base_url_js ?>',

                    // --- Initialization ---
                    init() {
                        this.$nextTick(() => { this.fetchDivisions(); });
                    },

                    // --- Generic Data Fetching ---
                    async fetchData(action, params = {}) { /* ... Keep enhanced version ... */
                        this.errorMessage = ''; const url = new URL(API_URL_NAMJARI); url.searchParams.append('action', action);
                        for (const key in params) { if (params[key] !== null && params[key] !== undefined && params[key] !== '') { url.searchParams.append(key, params[key]); } }
                        const fetchUrl = url.toString(); console.log(`Fetching: ${action}`, params);
                        try {
                            const response = await fetch(fetchUrl); let responseData = {};
                            try { responseData = await response.json(); console.log(`Response received for ${action}:`, { status: response.status, ok: response.ok }); } catch (e) { console.error(`Failed to parse JSON for ${action}:`, e); const textResponse = await response.text(); console.error('Response text:', textResponse); throw new Error(`Server returned non-JSON response. Status: ${response.status}`); }
                            if (!response.ok) { throw new Error(responseData.message || `HTTP error! Status: ${response.status}`); }
                            if (!responseData.success) { throw new Error(responseData.message || `API for action '${action}' reported failure.`); }
                            if (responseData.data === undefined || responseData.data === null) { console.warn(`Data field missing/null for action '${action}'. Returning [].`); return []; }
                            if (['get_divisions', 'get_districts', 'get_upazilas', 'get_mouzas', 'get_khatians'].includes(action)) { if (!Array.isArray(responseData.data)) { console.warn(`Expected array but received ${typeof responseData.data} for action '${action}'. Returning [].`); return []; } }
                            return responseData.data;
                        } catch (error) {
                            console.error(`Fetch error for action '${action}':`, error); this.errorMessage = `তথ্য আনতে সমস্যা হয়েছে (${action}): ${error.message}.`;
                            switch(action) { case 'get_divisions': this.divisions = []; break; case 'get_districts': this.districts = []; break; case 'get_upazilas': this.upazilas = []; break; case 'get_mouzas': this.mouzas = []; this.filteredMouzas = []; break; case 'get_khatians': this.khatians = []; this.filteredKhatians = []; break; } return null;
                        }
                    },
                    // --- Specific Data Fetching Methods ---
                    async fetchDivisions() { this.loadingDivisions = true; this.resetSelections(); const data = await this.fetchData('get_divisions'); this.divisions = Array.isArray(data) ? data : []; this.loadingDivisions = false; },
                    async fetchDistricts() { this.resetSelections('division'); if (!this.selectedDivisionBbs) return; this.loadingDistricts = true; const data = await this.fetchData('get_districts', { division_bbs: this.selectedDivisionBbs }); this.districts = Array.isArray(data) ? data : []; this.loadingDistricts = false; },
                    async fetchUpazilas() { this.resetSelections('district'); if (!this.selectedDistrictBbs || !this.selectedDivisionBbs) return; this.loadingUpazilas = true; const data = await this.fetchData('get_upazilas', { division_bbs: this.selectedDivisionBbs, district_bbs: this.selectedDistrictBbs }); this.upazilas = Array.isArray(data) ? data : []; this.loadingUpazilas = false; },
                    async fetchMouzas() { this.resetSelections('upazila'); if (!this.selectedDistrictBbs || !this.selectedUpazilaBbs) return; this.loadingMouzas = true; const data = await this.fetchData('get_mouzas', { district_bbs: this.selectedDistrictBbs, upazila_bbs: this.selectedUpazilaBbs }); this.mouzas = Array.isArray(data) ? data : []; this.filterMouzas(); this.loadingMouzas = false; },

                    // --- Filtering and Selection ---
                    filterMouzas() { if (!this.mouzaSearch.trim()) { this.filteredMouzas = [...this.mouzas]; } else { const s = this.mouzaSearch.toLowerCase().trim(); this.filteredMouzas = this.mouzas.filter(m => (m.name && m.name.toLowerCase().includes(s)) || (m.jl_no && String(m.jl_no).includes(s)) ); } if (this.selectedMouza && !this.filteredMouzas.some(m => m.id === this.selectedMouza.id)) { this.resetSelections('mouza'); } },
                    selectMouza(mouza) { if (!mouza || (this.selectedMouza && this.selectedMouza.id === mouza.id)) return; this.selectedMouza = mouza; this.mouzaSearch = mouza.name; this.resetSelections('khatian'); this.fetchKhatians(); },
                    async fetchKhatians() { this.resetSelections('khatian'); if (!this.selectedMouza || !this.selectedMouza.id) return; this.loadingKhatians = true; const data = await this.fetchData('get_khatians', { mouza_jl_id: this.selectedMouza.id }); this.khatians = Array.isArray(data) ? data : []; this.filterKhatians(); this.loadingKhatians = false; },

                    // **** MODIFIED filterKhatians ****
                    filterKhatians() {
                        if (!this.khatianSearch.trim()) {
                            this.filteredKhatians = [...this.khatians];
                        } else {
                            const s = this.khatianSearch.toLowerCase().trim();
                            this.filteredKhatians = this.khatians.filter(k => {
                                // Check Khatian Number (original and canonical) - partial match
                                const khatianNoMatch = (k.khatian_no && String(k.khatian_no).toLowerCase().includes(s)) ||
                                    (k.canonical_khatian_no && String(k.canonical_khatian_no).toLowerCase().includes(s));

                                // Check Owners - partial match
                                const ownerMatch = k.owners && k.owners.toLowerCase().includes(s);

                                // Check Dags - exact match for any dag number in the list
                                const dagMatch = k.dags && typeof k.dags === 'string' &&
                                    k.dags.split(',')
                                        .map(dag => dag.trim()) // Trim whitespace
                                        .filter(dag => dag !== '') // Remove empty entries if any
                                        .some(dag => dag === s); // Check if any dag *exactly* matches the search term

                                return khatianNoMatch || ownerMatch || dagMatch;
                            });
                        }
                    },
                    resetSelections(level = 'all') { console.log(`Resetting selections from level: ${level}`); if (level === 'all' || level === 'division') { this.selectedDistrictBbs = ''; this.districts = []; this.loadingDistricts = false; } if (level === 'all' || level === 'division' || level === 'district') { this.selectedUpazilaBbs = ''; this.upazilas = []; this.loadingUpazilas = false; } if (level === 'all' || level === 'division' || level === 'district' || level === 'upazila') { this.selectedMouza = null; this.mouzas = []; this.filteredMouzas = []; this.mouzaSearch = ''; this.loadingMouzas = false; } if (level === 'all' || level === 'division' || level === 'district' || level === 'upazila' || level === 'mouza' || level === 'khatian') { this.khatians = []; this.filteredKhatians = []; this.khatianSearch = ''; this.loadingKhatians = false; } },

                    // --- Link Generation Helpers ---
                    generateDagLinksHtml(dagsString, districtBbs, upazilaBbs, mouzajlId, mouza_id, survey_type) {
                        if (!dagsString || typeof dagsString !== 'string' || !districtBbs || !upazilaBbs || !mouzajlId) { return dagsString || '-'; }
                        const dagNumbers = dagsString.split(',').map(dag => dag.trim()).filter(dag => dag !== '');
                        if (dagNumbers.length === 0) return '-';
                        const linksHtml = dagNumbers.map(dagNo => {
                            const params = new URLSearchParams({
                                tool: 'search-map-dags', // Tool slug for map
                                dags: encodeURIComponent(dagsString), // Pass all dags for context if needed
                                dagno: encodeURIComponent(dagNo), // Specific dag for potential highlighting
                                district_bbs: encodeURIComponent(districtBbs),
                                upazila_bbs: encodeURIComponent(upazilaBbs),
                                mouza_jl_id: encodeURIComponent(mouzajlId), // Assuming mouzajlId is the correct ID for the map tool
                                mouza_id: encodeURIComponent(mouza_id), // Include specific mouza_id if different/needed
                                survey_type: encodeURIComponent(survey_type)
                            });
                            const url = `${this.phpBaseUrl}/tools.php?${params.toString()}`;
                            return `<a href="${url}" target="_blank" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 hover:underline whitespace-nowrap">${dagNo}</a>`;
                        });
                        return linksHtml.join(', ');
                    },

                    generateKhatianLinkHtml(khatian, districtBbs, upazilaBbs, mouzaId, survey_type) {
                        const khatianNo = khatian?.khatian_no || khatian?.canonical_khatian_no;
                        // --- TEMPORARILY REMOVED LINK GENERATION - JUST SHOW NUMBER ---
                        // This was removed in the original code provided in the request, keeping it that way.
                        // If you want links uncomment the section below and comment out the return khatianNo; line.
                        return khatianNo || '-';
                        /*
                        const khatianIdForLink = khatian?.id; // Use the specific khatian record ID

                        if (!khatianIdForLink || !khatianNo || !districtBbs || !upazilaBbs || !mouzaId) {
                            return khatianNo || '-';
                        }

                        const params = new URLSearchParams({
                            tool: 'src-khatian-no', // Target tool slug
                            khatianid: encodeURIComponent(khatianIdForLink),
                            khatian: encodeURIComponent(khatianNo),
                            mauza_id: encodeURIComponent(mouzaId),
                            district_bbs: encodeURIComponent(districtBbs),
                            upazila_bbs: encodeURIComponent(upazilaBbs),
                            mouza_jl_id: encodeURIComponent(mouzaId),
                            survey_type: encodeURIComponent(survey_type)
                        });

                        const url = `${this.phpBaseUrl}/tools.php?${params.toString()}`;

                        return `<a href="${url}" target="_blank" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 hover:underline whitespace-nowrap font-medium">${khatianNo}</a>`;
                        */
                    }

                } // End return object
            } // End namjariSearch function
        } // End if typeof check
    </script>
<?php // --- END Alpine JS logic --- ?>
# /api/namjari-khatian-ajax.php
  <?php
/* ================================================================ */
/* PHP API Backend Logic                                            */
/* ================================================================ */

// --- Error Reporting & Headers (Keep as before) ---
error_reporting(E_ALL);
ini_set('display_errors', 1);
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: GET, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type, X-Requested-With');
header('Content-Type: application/json; charset=utf-8');
if (isset($_SERVER['REQUEST_METHOD']) && $_SERVER['REQUEST_METHOD'] == 'OPTIONS') { http_response_code(200); exit(); }

// --- Database Configuration (REMINDER: Move credentials out) ---
$host = "172.188.89.41"; $username = "bdland"; $password = "8WF7LLRWHALsFjinvFU4"; $database = "bdland";

// --- Database Connection (Keep as before) ---
$mysqli = @new mysqli($host, $username, $password, $database);
if ($mysqli->connect_errno) { http_response_code(500); error_log("DB Connect failed: #" . $mysqli->connect_errno . " - " . $mysqli->connect_error); echo json_encode(['success' => false, 'message' => "System Error: DB Connect.", 'data' => null], JSON_UNESCAPED_UNICODE); exit(); }
if (!$mysqli->set_charset('utf8mb4')) { http_response_code(500); error_log("Error loading charset utf8mb4: " . $mysqli->error); echo json_encode(['success' => false, 'message' => "System Error: DB Charset.", 'data' => null], JSON_UNESCAPED_UNICODE); $mysqli->close(); exit(); }

// Sanitize output function
function sanitize_output($string) { return htmlspecialchars($string ?? '', ENT_QUOTES, 'UTF-8'); }

// --- Input Handling ---
$action = $_GET['action'] ?? null;
$response = ['success' => false, 'message' => 'Invalid action.', 'data' => []];

// --- Action Routing ---
if ($action) {
    try {
        switch ($action) {

            // --- get_divisions case (Keep as before with duplicate handling) ---
            case 'get_divisions':
                $sql = "SELECT DISTINCT division_name, division_bbs_code FROM namjari_mouzas WHERE division_bbs_code IS NOT NULL AND division_name IS NOT NULL AND division_name != '' ORDER BY division_bbs_code, division_name ASC";
                $result = $mysqli->query($sql); if (!$result) throw new Exception("DB Error divisions: " . $mysqli->error);
                $divisions_raw = []; while ($row = $result->fetch_assoc()) { $divisions_raw[] = $row; } $result->free();
                $divisions_unique_map = []; foreach ($divisions_raw as $row) { $bbs_code = $row['division_bbs_code']; $name = trim($row['division_name']); if (!isset($divisions_unique_map[$bbs_code])) { $divisions_unique_map[$bbs_code] = sanitize_output($name); } }
                $divisions_final = []; foreach ($divisions_unique_map as $bbs_code => $name) { $divisions_final[] = ['bbs_code' => $bbs_code, 'name' => $name]; }
                usort($divisions_final, fn($a, $b) => strcoll($a['name'], $b['name']));
                $response = ['success' => true, 'message' => 'Divisions fetched.', 'data' => $divisions_final];
                break;

            // --- get_districts case (Keep as before with duplicate handling) ---
            case 'get_districts':
                $divisionBbs = isset($_GET['division_bbs']) ? intval($_GET['division_bbs']) : 0; if (!$divisionBbs) throw new Exception("Division BBS code is required.");
                $sql = "SELECT DISTINCT district_name, district_bbs_code FROM namjari_mouzas WHERE division_bbs_code = ? AND district_bbs_code IS NOT NULL AND district_name IS NOT NULL AND district_name != '' ORDER BY district_bbs_code, district_name ASC";
                $stmt = $mysqli->prepare($sql); if (!$stmt) throw new Exception("DB Prepare Error (Districts): " . $mysqli->error);
                $stmt->bind_param("i", $divisionBbs); if (!$stmt->execute()) throw new Exception("DB Execute Error (Districts): " . $stmt->error);
                $result = $stmt->get_result(); $districts_raw = []; while ($row = $result->fetch_assoc()) { $districts_raw[] = $row; } $stmt->close();
                $districts_unique_map = []; foreach ($districts_raw as $row) { $bbs_code = $row['district_bbs_code']; $name = trim($row['district_name']); if (!isset($districts_unique_map[$bbs_code])) { $districts_unique_map[$bbs_code] = sanitize_output($name); } }
                $districts_final = []; foreach ($districts_unique_map as $bbs_code => $name) { $districts_final[] = ['bbs_code' => $bbs_code, 'name' => $name]; }
                usort($districts_final, fn($a, $b) => strcoll($a['name'], $b['name']));
                $response = ['success' => true, 'message' => 'Districts fetched.', 'data' => $districts_final];
                break;

            // --- get_upazilas case (Keep as before, add duplicate check if needed) ---
            case 'get_upazilas':
                $divisionBbs = isset($_GET['division_bbs']) ? intval($_GET['division_bbs']) : 0; $districtBbs = isset($_GET['district_bbs']) ? intval($_GET['district_bbs']) : 0; if (!$divisionBbs || !$districtBbs) throw new Exception("Division and District BBS codes are required.");
                $sql = "SELECT DISTINCT upazila_name, upazila_bbs_code FROM namjari_mouzas WHERE division_bbs_code = ? AND district_bbs_code = ? AND upazila_bbs_code IS NOT NULL AND upazila_name IS NOT NULL AND upazila_name != '' ORDER BY upazila_name ASC";
                $stmt = $mysqli->prepare($sql); if (!$stmt) throw new Exception("DB Prepare Error (Upazilas): " . $mysqli->error);
                $stmt->bind_param("ii", $divisionBbs, $districtBbs); if (!$stmt->execute()) throw new Exception("DB Execute Error (Upazilas): " . $stmt->error);

                $bbscodes = [];
                $result = $stmt->get_result(); $upazilas = [];

                while ($row = $result->fetch_assoc()) {
                    if(in_array($row['upazila_bbs_code'],$bbscodes))
                    {
                        continue;
                    }
                    $bbscodes[$row['upazila_bbs_code']] = $row['upazila_bbs_code'];


                    $upazilas[] = ['bbs_code' => $row['upazila_bbs_code'], 'name' => sanitize_output(trim($row['upazila_name']))];
                } $stmt->close();
                $response = ['success' => true, 'message' => 'Upazilas fetched.', 'data' => $upazilas];
                break;

            // --- get_mouzas case (Keep as before) ---
            case 'get_mouzas':
                $districtBbs = isset($_GET['district_bbs']) ? intval($_GET['district_bbs']) : 0;
                $upazilaBbs = isset($_GET['upazila_bbs']) ? intval($_GET['upazila_bbs']) : 0;
                $searchTerm = isset($_GET['search']) ? trim($_GET['search']) : '';

                if (!$districtBbs || !$upazilaBbs) {
                    throw new Exception("District and Upazila BBS codes are required.");
                }

                $params = [$districtBbs, $upazilaBbs];
                $types = "ii";

                // -- FIX APPLIED HERE --
                // Added DISTINCT to prevent sending duplicate mouzas which breaks the frontend.
                $sql = "SELECT DISTINCT source_id, mouza_name, jl_number FROM namjari_mouzas WHERE district_bbs_code = ? AND upazila_bbs_code = ? ";

                if (!empty($searchTerm)) {
                    $searchTermWild = '%' . $searchTerm . '%';
                    $sql .= " AND (jl_number LIKE ? OR mouza_name LIKE ?) ";
                    $params[] = $searchTermWild;
                    $params[] = $searchTermWild;
                    $types .= "ss";
                }

                $sql .= " ORDER BY CAST(jl_number AS UNSIGNED), jl_number, mouza_name ASC LIMIT 300";

                $stmt = $mysqli->prepare($sql);
                if (!$stmt) {
                    throw new Exception("DB Prepare Error (Mouzas): " . $mysqli->error);
                }

                $stmt->bind_param($types, ...$params);
                if (!$stmt->execute()) {
                    throw new Exception("DB Execute Error (Mouzas): " . $stmt->error);
                }

                $result = $stmt->get_result();
                $mouzas = [];
                while ($row = $result->fetch_assoc()) {
                    $jl = $row['jl_number'] ?? '?';
                    $name = trim($row['mouza_name'] ?? 'Unknown');
                    $mouzas[] = [
                        'id' => $row['source_id'],
                        'name' => sanitize_output($jl) . ' - ' . sanitize_output($name)
                    ];
                }
                $stmt->close();

                $response = ['success' => true, 'message' => 'Mouzas fetched.', 'data' => $mouzas];
                break;


            // --- get_khatians case (MODIFIED) ---
            case 'get_khatians':
                $mouzaJlId = isset($_GET['mouza_jl_id']) ? intval($_GET['mouza_jl_id']) : 0;
                $searchTerm = isset($_GET['search']) ? trim($_GET['search']) : '';
                // $surveyType = isset($_GET['survey_type']) ? trim($_GET['survey_type']) : 'MUTATION'; // No longer needed

                if (!$mouzaJlId) {
                    throw new Exception("Mouza JL ID (source_id) is required.");
                }
                // if (empty($surveyType)) { throw new Exception("Survey type is required."); } // No longer needed

                // Parameters only include mouza ID now
                $params = [$mouzaJlId];
                $types = "i";

                // Select fields
                $sql = "SELECT source_khatian_id, khatian_no, owners, dags, total_land, guardians, canonical_khatian_no, survey_type, mouza_id
                        FROM namjari_khatians
                        WHERE jl_number_id = ? "; // REMOVED: AND survey_type = ?

                // Add search condition if present
                if (!empty($searchTerm)) {
                    $searchTermWild = '%' . $searchTerm . '%';
                    $sql .= " AND (khatian_no LIKE ? OR canonical_khatian_no LIKE ? OR owners LIKE ?) ";
                    $params[] = $searchTermWild;
                    $params[] = $searchTermWild;
                    $params[] = $searchTermWild;
                    $types .= "sss"; // Types for the search parameters
                }

                $sql .= " ORDER BY CAST(khatian_no AS UNSIGNED), khatian_no ASC LIMIT 5000"; // Limit results

                $stmt = $mysqli->prepare($sql);
                if (!$stmt) throw new Exception("DB Prepare Error (Khatians): " . $mysqli->error);

                $stmt->bind_param($types, ...$params); // Bind parameters
                if (!$stmt->execute()) throw new Exception("DB Execute Error (Khatians): " . $stmt->error);
                $result = $stmt->get_result();

                $khatians = [];
                while ($row = $result->fetch_assoc()) {
                    $khatians[] = [
                        'id' => $row['source_khatian_id'],
                        'khatian_no' => sanitize_output($row['khatian_no']),
                        'canonical_khatian_no' => sanitize_output($row['canonical_khatian_no']),
                        'owners' => sanitize_output($row['owners']),
                        'guardians' => sanitize_output($row['guardians']),
                        'dags' => sanitize_output($row['dags']),
                        'total_land' => $row['total_land'],
                        'mouza_id' => $row['mouza_id'],
                        // Optional: Include survey_type in response if you want to display it
                         'survey_type' => sanitize_output($row['survey_type'])
                    ];
                }
                $stmt->close();
                $response = ['success' => true, 'message' => 'Khatians fetched (all survey types).', 'data' => $khatians];
                break; // End case 'get_khatians'


            default:
                http_response_code(400);
                throw new Exception("Invalid action specified.");
        }
    } catch (Exception $e) {
        error_log("AJAX Action Error (" . ($action ?? 'N/A') . "): " . $e->getMessage());
        $response = ['success' => false, 'message' => 'Server Error: ' . sanitize_output($e->getMessage()), 'data' => []];
        if (http_response_code() == 200) { http_response_code(500); }
    }
} else {
    http_response_code(400);
    $response['message'] = 'No action specified.';
}

// --- Close Connection ---
if ($mysqli) {
    $mysqli->close();
}

// --- Output JSON ---
echo json_encode($response, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
exit;
?>

#/test/holding-browser.php
  <?php
define('DB_HOST', '172.188.89.41'); // Or your production host
define('DB_USER', 'bdlanduser');
define('DB_PASS', '8WF7LLRWHALsFjinvFU4');
define('DB_NAME', 'bdland');
$mysqli = new mysqli(DB_HOST, DB_USER, DB_PASS, DB_NAME);


$districts = [];
$result = $mysqli->query("SELECT DISTINCT id, name_bn FROM holdings_districts ORDER BY name_bn ASC");
if ($result) {
    while ($row = $result->fetch_assoc()) {
        $districts[] = $row;
    }
    $result->free();
}
?>
<!DOCTYPE html>
<html lang="bn" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ভূমি হোল্ডিং ব্রাউজার</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        body { font-family: 'Hind Siliguri', 'Noto Sans Bengali', sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #edf2f7; border-radius: 10px; }
        .dark ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #a0aec0; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #4a5568; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #2c5282; }
        .table-responsive { overflow-x: auto; }
        .filter-section label { margin-bottom: 0.25rem; }
        .filter-section select, .filter-section input { transition: all 0.2s ease-in-out; }
        .badge { padding: 0.25em 0.6em; font-size: 0.75em; font-weight: 700; line-height: 1; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: 0.375rem; }
        .modal-content-item strong { min-width: 120px; display: inline-block; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&family=Noto+Sans+Bengali:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Hind Siliguri', 'Noto Sans Bengali', 'ui-sans-serif', 'system-ui'], },
                    colors: { 'brand-primary': '#00796B', 'brand-secondary': '#FFC107', 'brand-primary-dark': '#004D40', 'brand-secondary-dark': '#FFA000', },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out', 'slide-up': 'slideUp 0.3s ease-out', },
                    keyframes: { fadeIn: { '0%': { opacity: 0 }, '100%': { opacity: 1 }, }, slideUp: { '0%': { opacity: 0, transform: 'translateY(20px)' }, '100%': { opacity: 1, transform: 'translateY(0)' }, } }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 antialiased"
      x-data="holdingBrowser()" x-init="init()">

<nav class="bg-white dark:bg-slate-800 shadow-md sticky top-0 z-50">
    <div class="container mx-auto px-4">
        <div class="flex justify-between items-center py-3">
            <a href="#" class="flex items-center space-x-2">
                <i class="fas fa-landmark text-2xl text-brand-primary dark:text-sky-400"></i>
                <span class="text-xl font-semibold text-brand-primary dark:text-sky-400">ভূমি তথ্য</span>
            </a>
            <div class="flex items-center space-x-3">
                <button @click="toggleAdvancedFilters()" title="ফিল্টার" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700 focus:outline-none">
                    <i class="fas fa-filter text-lg" :class="showAdvancedFilters ? 'text-brand-primary dark:text-sky-400' : 'text-gray-600 dark:text-gray-400'"></i>
                </button>
                <button @click="toggleDarkMode()" title="ডার্ক মোড" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700 focus:outline-none">
                    <i x-show="!darkMode" class="fas fa-moon text-lg"></i>
                    <i x-show="darkMode" class="fas fa-sun text-lg"></i>
                </button>
            </div>
        </div>
    </div>
</nav>

<div class="container mx-auto p-4 md:p-6">
    <div class="mb-6 bg-white dark:bg-slate-800 p-4 sm:p-6 rounded-xl shadow-lg">
        <label for="search" class="sr-only">অনুসন্ধান</label>
        <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fas fa-search text-gray-400"></i>
            </div>
            <input type="search" id="search" x-model.debounce.500ms="searchQuery" @input="fetchHoldings(1)"
                   placeholder="হোল্ডিং নং, মালিকের নাম, খতিয়ান, দাগ, এনআইডি, মোবাইল দিয়ে অনুসন্ধান করুন..."
                   class="block w-full p-3 pl-10 text-sm border border-gray-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-brand-primary dark:focus:ring-sky-500 focus:border-transparent dark:bg-slate-700 dark:placeholder-gray-400">
        </div>
    </div>

    <div x-show="showAdvancedFilters" x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform -translate-y-4" x-transition:enter-end="opacity-100 transform translate-y-0"
         x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 transform translate-y-0" x-transition:leave-end="opacity-0 transform -translate-y-4"
         class="filter-section mb-6 bg-white dark:bg-slate-800 p-4 sm:p-6 rounded-xl shadow-lg">
        <h3 class="text-lg font-semibold mb-4 border-b dark:border-slate-700 pb-2">বিস্তারিত ফিল্টার</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 items-end">
            <div>
                <label for="owner_name_filter" class="block text-sm font-medium text-gray-700 dark:text-slate-300">মালিকের নাম</label>
                <input type="text" id="owner_name_filter" x-model.debounce.300ms="filterOwnerName" placeholder="মালিকের নাম"
                       class="mt-1 block w-full p-2.5 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm focus:ring-brand-primary dark:focus:ring-sky-500 focus:border-brand-primary dark:focus:border-sky-500 dark:bg-slate-700">
            </div>
            <div>
                <label for="father_name_filter" class="block text-sm font-medium text-gray-700 dark:text-slate-300">পিতার নাম</label>
                <input type="text" id="father_name_filter" x-model.debounce.300ms="filterFatherName" placeholder="পিতার নাম"
                       class="mt-1 block w-full p-2.5 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm focus:ring-brand-primary dark:focus:ring-sky-500 focus:border-brand-primary dark:focus:border-sky-500 dark:bg-slate-700">
            </div>
            <div>
                <label for="nid_filter" class="block text-sm font-medium text-gray-700 dark:text-slate-300">এনআইডি নম্বর</label>
                <input type="text" id="nid_filter" x-model.debounce.300ms="filterNid" placeholder="এনআইডি নম্বর"
                       class="mt-1 block w-full p-2.5 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm focus:ring-brand-primary dark:focus:ring-sky-500 focus:border-brand-primary dark:focus:border-sky-500 dark:bg-slate-700">
            </div>
            <div>
                <label for="mobile_filter" class="block text-sm font-medium text-gray-700 dark:text-slate-300">মোবাইল নম্বর</label>
                <input type="text" id="mobile_filter" x-model.debounce.300ms="filterMobile" placeholder="মোবাইল নম্বর"
                       class="mt-1 block w-full p-2.5 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm focus:ring-brand-primary dark:focus:ring-sky-500 focus:border-brand-primary dark:focus:border-sky-500 dark:bg-slate-700">
            </div>
            <div>
                <label for="khotian_no_filter" class="block text-sm font-medium text-gray-700 dark:text-slate-300">খতিয়ান নং</label>
                <input type="text" id="khotian_no_filter" x-model.debounce.300ms="filterKhotianNo" placeholder="খতিয়ান নং"
                       class="mt-1 block w-full p-2.5 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm focus:ring-brand-primary dark:focus:ring-sky-500 focus:border-brand-primary dark:focus:border-sky-500 dark:bg-slate-700">
            </div>
            <div>
                <label for="dag_no_filter" class="block text-sm font-medium text-gray-700 dark:text-slate-300">দাগ নং</label>
                <input type="text" id="dag_no_filter" x-model.debounce.300ms="filterDagNo" placeholder="দাগ নং"
                       class="mt-1 block w-full p-2.5 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm focus:ring-brand-primary dark:focus:ring-sky-500 focus:border-brand-primary dark:focus:border-sky-500 dark:bg-slate-700">
            </div>
            <div>
                <label for="district" class="block text-sm font-medium text-gray-700 dark:text-slate-300">জেলা</label>
                <select id="district" x-model="selectedDistrict" @change="fetchUpazilas(); applyAdvancedFilters()"
                        class="mt-1 block w-full p-2.5 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm focus:ring-brand-primary dark:focus:ring-sky-500 focus:border-brand-primary dark:focus:border-sky-500 dark:bg-slate-700">
                    <option value="">-- সকল জেলা --</option>
                    <template x-for="district in districts" :key="district.id"> <option :value="district.id" x-text="district.name_bn"></option> </template>
                </select>
            </div>
            <div>
                <label for="upazila" class="block text-sm font-medium text-gray-700 dark:text-slate-300">উপজেলা</label>
                <select id="upazila" x-model="selectedUpazila" @change="fetchMoujas(); applyAdvancedFilters()" :disabled="!selectedDistrict || upazilasLoading"
                        class="mt-1 block w-full p-2.5 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm focus:ring-brand-primary dark:focus:ring-sky-500 focus:border-brand-primary dark:focus:border-sky-500 dark:bg-slate-700 disabled:opacity-50">
                    <option value="">-- সকল উপজেলা --</option>
                    <template x-if="upazilasLoading"><option value="" disabled>লোড হচ্ছে...</option></template>
                    <template x-for="upazila in upazilas" :key="upazila.id"> <option :value="upazila.id" x-text="upazila.name_bd"></option> </template>
                </select>
            </div>
            <div>
                <label for="mouja" class="block text-sm font-medium text-gray-700 dark:text-slate-300">মৌজা</label>
                <select id="mouja" x-model="selectedMouja" @change="applyAdvancedFilters()" :disabled="!selectedUpazila || moujasLoading"
                        class="mt-1 block w-full p-2.5 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm focus:ring-brand-primary dark:focus:ring-sky-500 focus:border-brand-primary dark:focus:border-sky-500 dark:bg-slate-700 disabled:opacity-50">
                    <option value="">-- সকল মৌজা --</option>
                    <template x-if="moujasLoading"><option value="" disabled>লোড হচ্ছে...</option></template>
                    <template x-for="mouja in moujas" :key="mouja.id"> <option :value="mouja.id" x-text="mouja.name_bd"></option> </template>
                </select>
            </div>
            <div class="lg:col-span-4 flex justify-end items-end space-x-2 pt-4">
                <button @click="applyAdvancedFilters()" class="w-auto px-6 py-2.5 bg-brand-primary hover:bg-opacity-90 dark:bg-sky-600 dark:hover:bg-sky-500 text-white rounded-md shadow-sm flex items-center justify-center">
                    <i class="fas fa-search mr-2"></i> ফিল্টার
                </button>
                <button @click="resetFilters()" title="ফিল্টার রিসেট করুন" class="w-auto px-4 py-2.5 bg-red-500 hover:bg-red-600 text-white rounded-md shadow-sm">
                    <i class="fas fa-times"></i> রিসেট
                </button>
            </div>
        </div>
    </div>

    <div x-show="isLoading" class="text-center py-12" aria-live="polite">
        <i class="fas fa-spinner fa-pulse text-5xl text-brand-primary dark:text-sky-400"></i>
        <p class="mt-3 text-lg font-medium">তথ্য লোড হচ্ছে...</p>
    </div>

    <div x-show="!isLoading && totalRecords > 0" class="mb-4 flex justify-between items-center">
        <p class="text-sm text-gray-600 dark:text-slate-400"> মোট <strong class="text-brand-primary dark:text-sky-400" x-text="totalRecords.toLocaleString('bn-BD')"></strong> টি হোল্ডিং পাওয়া গেছে। </p>
    </div>

    <div x-show="!isLoading && holdings.length > 0" class="animate-fade-in">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
            <template x-for="holding in holdings" :key="holding.core_holding_id">
                <div @click="openModal(holding.core_holding_id)" class="bg-white dark:bg-slate-800 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 cursor-pointer overflow-hidden flex flex-col">
                    <div class="p-5 flex-grow">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-lg font-semibold text-brand-primary dark:text-sky-400" x-text="`হোল্ডিং নং: ${holding.holding_no_main || holding.holding_no_core}`"></h3>
                            <span class="badge text-xs" :class="holding.tax_clear_year ? (parseInt(holding.tax_clear_year) >= new Date().getFullYear() - 2 ? 'bg-green-100 text-green-700 dark:bg-green-700 dark:text-green-100' : 'bg-red-100 text-red-700 dark:bg-red-700 dark:text-red-100') : 'bg-yellow-100 text-yellow-700 dark:bg-yellow-700 dark:text-yellow-100'" x-text="holding.tax_clear_year ? `কর: ${holding.tax_clear_year}` : 'কর অজানা'"></span>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-slate-300 mb-1"><i class="fas fa-user fa-fw mr-2 text-gray-400 dark:text-slate-500"></i><strong class="font-medium">মালিক:</strong> <span x-text="truncateText(holding.owner_name || 'N/A', 30)"></span></p>
                        <p class="text-sm text-gray-600 dark:text-slate-300 mb-1"><i class="fas fa-map-marker-alt fa-fw mr-2 text-gray-400 dark:text-slate-500"></i><span x-text="`${holding.mouja_name || 'N/A'}, ${holding.upazila_name || 'N/A'}`"></span></p>
                        <p class="text-sm text-gray-600 dark:text-slate-300"><i class="fas fa-map fa-fw mr-2 text-gray-400 dark:text-slate-500"></i><span x-text="holding.district_name || 'N/A'"></span></p>
                    </div>
                    <div class="px-5 py-3 bg-gray-50 dark:bg-slate-700 border-t dark:border-slate-600 flex justify-between items-center">
                        <p class="text-sm font-medium">মোট দাবি: <span class="text-brand-primary dark:text-sky-400" x-text="`৳${holding.total_demand ? parseFloat(holding.total_demand).toLocaleString('bn-BD', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '০.০০'}`"></span></p>
                        <span class="text-xs text-brand-primary dark:text-sky-400 hover:underline">বিস্তারিত দেখুন <i class="fas fa-arrow-right ml-1"></i></span>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <div x-show="!isLoading && holdings.length === 0 && !initialLoad" class="text-center py-12 bg-white dark:bg-slate-800 rounded-xl shadow-lg animate-fade-in">
        <i class="fas fa-folder-open text-6xl text-gray-300 dark:text-slate-600 mb-4"></i>
        <p class="text-xl font-semibold mb-2">কোনো তথ্য পাওয়া যায়নি</p>
        <p class="text-gray-600 dark:text-slate-400">অনুগ্রহ করে আপনার ফিল্টার পরিবর্তন করুন অথবা নতুন অনুসন্ধান করুন।</p>
    </div>

    <div x-show="!isLoading && totalRecords > 0" class="mt-8 flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
        <p class="text-sm text-gray-600 dark:text-slate-400"> মোট <strong x-text="totalRecords.toLocaleString('bn-BD')"></strong> টি রেকর্ডের মধ্যে <strong x-text="((currentPage - 1) * limit + 1).toLocaleString('bn-BD')"></strong> থেকে <strong x-text="Math.min(currentPage * limit, totalRecords).toLocaleString('bn-BD')"></strong> দেখানো হচ্ছে। </p>
        <nav class="flex items-center space-x-1 shadow-sm rounded-md bg-white dark:bg-slate-800 p-1">
            <button @click="changePage(currentPage - 1)" :disabled="currentPage === 1" class="px-3 py-2 rounded-md text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100 dark:hover:bg-slate-700"> <i class="fas fa-chevron-left"></i> </button>
            <template x-for="page in paginationRange()" :key="page"> <button @click="page !== '...' && changePage(page)" :class="{'bg-brand-primary text-white dark:bg-sky-600': page === currentPage, 'hover:bg-gray-100 dark:hover:bg-slate-700': page !== currentPage && page !== '...'}" class="px-4 py-2 rounded-md text-sm font-medium" x-text="page.toLocaleString ? page.toLocaleString('bn-BD') : page" :disabled="page === '...'"></button> </template>
            <button @click="changePage(currentPage + 1)" :disabled="currentPage === totalPages" class="px-3 py-2 rounded-md text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100 dark:hover:bg-slate-700"> <i class="fas fa-chevron-right"></i> </button>
        </nav>
    </div>
</div>

<div x-show="showModal" x-cloak class="fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center p-4 z-[100]" @click.self="closeModal()">
    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col animate-slide-up" @click.stop>
        <header class="px-6 py-4 border-b border-gray-200 dark:border-slate-700 flex justify-between items-center">
            <h3 class="text-xl font-semibold text-brand-primary dark:text-sky-400">হোল্ডিং বিস্তারিত</h3>
            <button @click="closeModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-slate-300 p-1 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700"> <i class="fas fa-times text-xl"></i> </button>
        </header>
        <main class="p-6 overflow-y-auto flex-grow space-y-6">
            <div x-show="modalLoading" class="text-center py-10"> <i class="fas fa-spinner fa-pulse text-4xl text-brand-primary dark:text-sky-400"></i> <p class="mt-2">বিস্তারিত লোড হচ্ছে...</p> </div>
            <div x-show="!modalLoading && modalHolding.details" class="space-y-6">
                <section class="p-4 bg-gray-50 dark:bg-slate-700/50 rounded-lg">
                    <h4 class="text-lg font-semibold mb-3 text-gray-700 dark:text-slate-300 border-b dark:border-slate-600 pb-2 flex items-center"> <i class="fas fa-info-circle mr-2 text-brand-primary dark:text-sky-400"></i>সাধারণ তথ্য </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3 text-sm modal-content-item">
                        <p><strong>হোল্ডিং নং:</strong> <span x-text="modalHolding.details.holding_no_main || modalHolding.details.holding_no_core"></span></p>
                        <p><strong>খতিয়ান নং (Core):</strong> <span x-text="modalHolding.details.khotian_no_core || 'N/A'"></span></p>
                        <p><strong>জেলা:</strong> <span x-text="modalHolding.details.district_name || 'N/A'"></span></p>
                        <p><strong>উপজেলা:</strong> <span x-text="modalHolding.details.upazila_name || 'N/A'"></span></p>
                        <p><strong>মৌজা:</strong> <span x-text="modalHolding.details.mouja_name || 'N/A'"></span></p>
                        <p><strong>অনুমোদিত?:</strong> <span class="badge text-xs" :class="modalHolding.details.is_approve_main ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'" x-text="modalHolding.details.is_approve_main ? 'হ্যাঁ' : 'না'"></span></p>
                    </div>
                </section>
                <section class="p-4 bg-gray-50 dark:bg-slate-700/50 rounded-lg">
                    <h4 class="text-lg font-semibold mb-3 text-gray-700 dark:text-slate-300 border-b dark:border-slate-600 pb-2 flex items-center"> <i class="fas fa-coins mr-2 text-brand-primary dark:text-sky-400"></i>ভূমি করের তথ্য </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3 text-sm modal-content-item">
                        <p><strong>কর পরিশোধিত বছর:</strong> <span x-text="modalHolding.details.tax_clear_year || 'N/A'"></span></p>
                        <p><strong>বকেয়া বছর সংখ্যা:</strong> <span x-text="(modalHolding.details.no_of_tax_pending_year || 0).toLocaleString('bn-BD')"></span></p>
                        <p><strong>মোট দাবি:</strong> <span x-text="`৳${modalHolding.details.total_demand ? parseFloat(modalHolding.details.total_demand).toLocaleString('bn-BD', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '০.০০'}`"></span></p>
                        <p><strong>বার্ষিক দাবি:</strong> <span x-text="`৳${modalHolding.details.yearly_demand ? parseFloat(modalHolding.details.yearly_demand).toLocaleString('bn-BD', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '০.০০'}`"></span></p>
                        <p><strong>বর্তমান দাবি:</strong> <span x-text="`৳${modalHolding.details.current_demand ? parseFloat(modalHolding.details.current_demand).toLocaleString('bn-BD', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '০.০০'}`"></span></p>
                        <p><strong>বকেয়া সুদ:</strong> <span x-text="`৳${modalHolding.details.due_interest ? parseFloat(modalHolding.details.due_interest).toLocaleString('bn-BD', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '০.০০'}`"></span></p>
                        <p><strong>নাগরিক আইডি:</strong> <span x-text="modalHolding.details.citizen_id || 'N/A'"></span></p>
                    </div>
                </section>
                <section x-show="modalHolding.owners && modalHolding.owners.length > 0" class="p-4 bg-gray-50 dark:bg-slate-700/50 rounded-lg">
                    <h4 class="text-lg font-semibold mb-3 text-gray-700 dark:text-slate-300 border-b dark:border-slate-600 pb-2 flex items-center"> <i class="fas fa-users mr-2 text-brand-primary dark:text-sky-400"></i>মালিকের তথ্য (<span x-text="(modalHolding.owners ? modalHolding.owners.length : 0).toLocaleString('bn-BD')"></span>) </h4>
                    <div class="max-h-60 overflow-y-auto pr-2 space-y-3">
                        <template x-for="(owner, index) in modalHolding.owners" :key="owner.id">
                            <div class="p-3 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-800">
                                <p class="font-semibold text-brand-primary dark:text-sky-500"><span x-text="(index + 1).toLocaleString('bn-BD')"></span>. <span x-text="owner.name"></span></p>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1 text-xs pl-2 text-gray-600 dark:text-slate-300 modal-content-item">
                                    <p><strong>পিতার নাম:</strong> <span x-text="owner.father_name || 'N/A'"></span></p>
                                    <p><strong>মোবাইল:</strong>
                                        <template x-if="owner.mobile_no">
                                            <button @click.prevent.stop="searchByMobile(owner.mobile_no)" class="text-sky-600 hover:text-sky-800 dark:text-sky-400 dark:hover:text-sky-300 underline">
                                                <span x-text="owner.mobile_no"></span> <i class="fas fa-search-plus fa-xs ml-1"></i>
                                            </button>
                                        </template>
                                        <template x-else><span>N/A</span></template>
                                    </p>
                                    <p><strong>এনআইডি:</strong>
                                        <template x-if="owner.nid">
                                            <button @click.prevent.stop="searchByNid(owner.nid)" class="text-sky-600 hover:text-sky-800 dark:text-sky-400 dark:hover:text-sky-300 underline">
                                                <span x-text="owner.nid"></span> <i class="fas fa-search-plus fa-xs ml-1"></i>
                                            </button>
                                        </template>
                                        <template x-else><span>N/A</span></template>
                                    </p>
                                    <p><strong>ঠিকানা:</strong> <span x-text="owner.address || 'N/A'"></span></p>
                                    <p><strong>জমির অংশ:</strong> <span x-text="owner.land_portion || 'N/A'"></span></p>
                                    <p><strong>কর পরিশোধিত বছর:</strong> <span x-text="owner.tax_clear_year_owner || 'N/A'"></span></p>
                                </div>
                            </div>
                        </template>
                    </div>
                </section>
                <section x-show="modalHolding.schedules && modalHolding.schedules.length > 0" class="p-4 bg-gray-50 dark:bg-slate-700/50 rounded-lg">
                    <h4 class="text-lg font-semibold mb-3 text-gray-700 dark:text-slate-300 border-b dark:border-slate-600 pb-2 flex items-center"> <i class="fas fa-layer-group mr-2 text-brand-primary dark:text-sky-400"></i>জমির তফসিল (<span x-text="(modalHolding.schedules ? modalHolding.schedules.length : 0).toLocaleString('bn-BD')"></span>) </h4>
                    <div class="max-h-60 overflow-y-auto pr-2 space-y-3">
                        <template x-for="(schedule, index) in modalHolding.schedules" :key="schedule.id">
                            <div class="p-3 border dark:border-slate-600 rounded-md bg-white dark:bg-slate-800">
                                <p class="font-semibold text-brand-primary dark:text-sky-500"><span x-text="(index + 1).toLocaleString('bn-BD')"></span>. দাগ নং: <span x-text="schedule.dag_no"></span>, জমির প্রকার: <span x-text="schedule.land_type_name"></span></p>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1 text-xs pl-2 text-gray-600 dark:text-slate-300 modal-content-item">
                                    <p><strong>খতিয়ান নং:</strong> <span x-text="schedule.khotian_no_schedule || 'N/A'"></span></p>
                                    <p><strong>জমির পরিমাণ:</strong> <span x-text="schedule.amount_of_land ? parseFloat(schedule.amount_of_land).toLocaleString('bn-BD', {minimumFractionDigits: 2, maximumFractionDigits: 4}) : '০.০০'"></span></p>
                                    <p class="sm:col-span-2"><strong>মন্তব্য:</strong> <span x-text="schedule.comments || 'N/A'"></span></p>
                                    <template x-if="schedule.tax_info">
                                        <div class="sm:col-span-2 mt-1 pt-2 border-t dark:border-slate-700">
                                            <p class="font-medium text-gray-700 dark:text-slate-200">ব্যবহারভিত্তিক করের তথ্য:</p>
                                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4">
                                                <p><strong>বর্তমান দাবি:</strong> <span x-text="`৳${schedule.tax_info.current_demand_tax ? parseFloat(schedule.tax_info.current_demand_tax).toLocaleString('bn-BD', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '০.০০'}`"></span></p>
                                                <p><strong>জমির পরিমাণ (কর):</strong> <span x-text="schedule.tax_info.amount_tax ? parseFloat(schedule.tax_info.amount_tax).toLocaleString('bn-BD', {minimumFractionDigits: 2, maximumFractionDigits: 4}) : '০.০০০০'"></span></p>
                                                <p><strong>শুরুর বছর:</strong> <span x-text="schedule.tax_info.start_year || 'N/A'"></span></p> <p><strong>শেষ বছর:</strong> <span x-text="schedule.tax_info.end_year || 'N/A'"></span></p>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </section>
            </div>
            <div x-show="!modalLoading && !modalHolding.details && !modalError" class="text-center py-10"> <p class="text-gray-600 dark:text-slate-400">বিস্তারিত তথ্য পাওয়া যায়নি।</p> </div>
            <div x-show="modalError" class="text-center py-10 text-red-500"> <i class="fas fa-exclamation-triangle text-3xl mb-2"></i> <p x-text="modalError"></p> </div>
        </main>
        <footer class="px-6 py-3 bg-gray-50 dark:bg-slate-700/50 border-t dark:border-slate-600 text-right">
            <button @click="closeModal()" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-slate-600 dark:hover:bg-slate-500 text-gray-800 dark:text-slate-200 rounded-md text-sm font-medium"> বন্ধ করুন </button>
        </footer>
    </div>
</div>

<script>
    function holdingBrowser() {
        return {
            isLoading: true, initialLoad: true, holdings: [], searchQuery: '', districts: <?php echo json_encode($districts); ?>, upazilas: [], moujas: [],
            selectedDistrict: '', selectedUpazila: '', selectedMouja: '', upazilasLoading: false, moujasLoading: false,
            filterOwnerName: '', filterFatherName: '', filterKhotianNo: '', filterDagNo: '', filterNid: '', filterMobile: '',
            showAdvancedFilters: false, currentPage: 1, totalPages: 0, totalRecords: 0, limit: 15,
            showModal: false, modalHolding: {}, modalLoading: false, modalError: '', darkMode: false, apiBaseUrl: 'https://4bd.org/api/holding-browser-ajax.php',

            init() {
                if (localStorage.getItem('darkMode') === 'true' || (!('darkMode' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    this.darkMode = true; document.documentElement.classList.add('dark');
                } else {
                    this.darkMode = false; document.documentElement.classList.remove('dark');
                }
                const urlParams = new URLSearchParams(window.location.search);
                this.searchQuery = urlParams.get('search') || '';
                this.selectedDistrict = urlParams.get('district') || '';
                this.filterOwnerName = urlParams.get('owner_name') || '';
                this.filterFatherName = urlParams.get('father_name') || '';
                this.filterKhotianNo = urlParams.get('khotian_no') || '';
                this.filterDagNo = urlParams.get('dag_no') || '';
                this.filterNid = urlParams.get('nid') || '';
                this.filterMobile = urlParams.get('mobile_no') || '';

                if (this.selectedDistrict || this.filterOwnerName || this.filterFatherName || this.filterKhotianNo || this.filterDagNo || this.filterNid || this.filterMobile ) {
                    this.showAdvancedFilters = true;
                }

                if (this.selectedDistrict) {
                    this.fetchUpazilas().then(() => {
                        this.selectedUpazila = urlParams.get('upazila') || '';
                        if (this.selectedUpazila) {
                            this.fetchMoujas().then(() => {
                                this.selectedMouja = urlParams.get('mouja') || '';
                                this.fetchHoldings(urlParams.get('page') || 1);
                            });
                        } else { this.fetchHoldings(urlParams.get('page') || 1); }
                    });
                } else { this.fetchHoldings(urlParams.get('page') || 1); }
            },
            toggleDarkMode() { this.darkMode = !this.darkMode; if (this.darkMode) { document.documentElement.classList.add('dark'); localStorage.setItem('darkMode', 'true'); } else { document.documentElement.classList.remove('dark'); localStorage.setItem('darkMode', 'false'); } },
            toggleAdvancedFilters() { this.showAdvancedFilters = !this.showAdvancedFilters; },
            applyAdvancedFilters() { this.fetchHoldings(1); },
            async fetchUpazilas() {
                if (!this.selectedDistrict) { this.upazilas = []; this.selectedUpazila = ''; this.moujas = []; this.selectedMouja = ''; return; }
                this.upazilasLoading = true; this.upazilas = []; this.selectedUpazila = ''; this.moujas = []; this.selectedMouja = '';
                try {
                    const response = await fetch(`${this.apiBaseUrl}?action=get_upazilas&district_id=${this.selectedDistrict}`);
                    const data = await response.json();
                    if (data.success) this.upazilas = data.upazilas; else console.error("Error fetching upazilas:", data.message);
                } catch (error) { console.error('Failed to fetch upazilas:', error); }
                finally { this.upazilasLoading = false; }
            },
            async fetchMoujas() {
                if (!this.selectedUpazila) { this.moujas = []; this.selectedMouja = ''; return; }
                this.moujasLoading = true; this.moujas = []; this.selectedMouja = '';
                try {
                    const response = await fetch(`${this.apiBaseUrl}?action=get_moujas&upazila_id=${this.selectedUpazila}`);
                    const data = await response.json();
                    if (data.success) this.moujas = data.moujas; else console.error("Error fetching moujas:", data.message);
                } catch (error) { console.error('Failed to fetch moujas:', error); }
                finally { this.moujasLoading = false; }
            },
            async fetchHoldings(page = 1) {
                this.isLoading = true; this.currentPage = parseInt(page) || 1;
                const params = new URLSearchParams({ page: this.currentPage, limit: this.limit });
                if (this.searchQuery.trim() !== '') params.append('search', this.searchQuery.trim());
                if (this.filterOwnerName.trim() !== '') params.append('owner_name', this.filterOwnerName.trim());
                if (this.filterFatherName.trim() !== '') params.append('father_name', this.filterFatherName.trim());
                if (this.filterKhotianNo.trim() !== '') params.append('khotian_no', this.filterKhotianNo.trim());
                if (this.filterDagNo.trim() !== '') params.append('dag_no', this.filterDagNo.trim());
                if (this.filterNid.trim() !== '') params.append('nid', this.filterNid.trim());
                if (this.filterMobile.trim() !== '') params.append('mobile_no', this.filterMobile.trim());
                if (this.selectedDistrict) params.append('district_id', this.selectedDistrict);
                if (this.selectedUpazila) params.append('upazila_id', this.selectedUpazila);
                if (this.selectedMouja) params.append('mouja_id', this.selectedMouja);
                const newUrl = `${window.location.pathname}?${params.toString()}`;
                window.history.pushState({path:newUrl},'',newUrl);
                try {
                    const response = await fetch(`${this.apiBaseUrl}?${params.toString()}`);
                    const data = await response.json();
                    if(data.success) { this.holdings = data.data; this.totalPages = data.totalPages; this.totalRecords = data.totalRecords; }
                    else { this.holdings = []; this.totalPages = 0; this.totalRecords = 0; console.error("Error fetching holdings:", data.message); }
                } catch (error) { console.error('Failed to fetch holdings:', error); this.holdings = []; this.totalPages = 0; this.totalRecords = 0; }
                finally { this.isLoading = false; this.initialLoad = false; }
            },
            changePage(page) { if (page >= 1 && page <= this.totalPages && page !== this.currentPage) { this.fetchHoldings(page); } },
            paginationRange() {
                const current = this.currentPage, last = this.totalPages, delta = 1, left = current - delta, right = current + delta + 1, range = [], rangeWithDots = []; let l;
                for (let i = 1; i <= last; i++) { if (i === 1 || i === last || (i >= left && i < right)) { range.push(i); } }
                for (let i of range) { if (l) { if (i - l === 2) { rangeWithDots.push(l + 1); } else if (i - l !== 1) { rangeWithDots.push('...'); } } rangeWithDots.push(i); l = i; }
                return rangeWithDots;
            },
            resetFilters() { this.searchQuery = ''; this.selectedDistrict = ''; this.selectedUpazila = ''; this.selectedMouja = ''; this.filterOwnerName = ''; this.filterFatherName = ''; this.filterKhotianNo = ''; this.filterDagNo = ''; this.filterNid = ''; this.filterMobile = ''; this.upazilas = []; this.moujas = []; this.showAdvancedFilters = false; this.fetchHoldings(1); },
            async openModal(holdingId) {
                this.showModal = true; this.modalLoading = true; this.modalHolding = {}; this.modalError = '';
                try {
                    const response = await fetch(`${this.apiBaseUrl}?holding_id=${holdingId}`);
                    const data = await response.json();
                    if(data.success && data.holdingData) {
                        this.modalHolding = { details: data.holdingData, owners: data.ownersData, schedules: data.schedulesData };
                        if (this.modalHolding.details) {
                            this.modalHolding.details.district_name = this.modalHolding.details.district_name_main || this.modalHolding.details.district_name_core_ref || 'N/A';
                            this.modalHolding.details.upazila_name = this.modalHolding.details.upazila_name_main || this.modalHolding.details.upazila_name_core_ref || 'N/A';
                            this.modalHolding.details.mouja_name = this.modalHolding.details.mouja_name_main || this.modalHolding.details.mouja_name_core_ref || 'N/A';
                        }
                    } else { this.modalError = data.message || "বিস্তারিত তথ্য পাওয়া যায়নি।"; console.error("Error fetching modal data:", data.message); }
                } catch (error) { this.modalError = "তথ্য আনতে সমস্যা হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।"; console.error('Failed to fetch modal data:', error); }
                finally { this.modalLoading = false; }
            },
            closeModal() { this.showModal = false; this.modalHolding = {}; this.modalLoading = false; this.modalError = ''; },
            truncateText(text, maxLength) { if (!text) return ''; if (text.length <= maxLength) return text; return text.substr(0, maxLength) + '...'; },
            searchByNid(nidValue) {
                if (!nidValue) return;
                this.filterNid = nidValue;
                this.showAdvancedFilters = true; this.closeModal(); this.applyAdvancedFilters();
            },
            searchByMobile(mobileValue) {
                if (!mobileValue) return;
                this.filterMobile = mobileValue;
                this.showAdvancedFilters = true; this.closeModal(); this.applyAdvancedFilters();
            }
        }
    }
</script>
</body>
</html>

# /api/holding-browser-ajax.php
<?php
// holding-browser-ajax.php

$allowed_origins = ['*'];
$origin = $_SERVER['HTTP_ORIGIN'] ?? '';

if (in_array('*', $allowed_origins) || in_array($origin, $allowed_origins)) {
    header('Access-Control-Allow-Origin: ' . ($origin ?: '*')); // Send back specific origin if matched, or '*' if allowed
    header('Access-Control-Allow-Methods: GET, POST, OPTIONS');
    header('Access-Control-Allow-Headers: Content-Type, Authorization'); // Add any other headers your frontend sends
    // header('Access-Control-Allow-Credentials: true'); // Uncomment if you use cookies/sessions
}

header('Content-Type: application/json');
require_once '../config.php'; // Adjust path to your config.php



$action = $_GET['action'] ?? null;
$response = ['success' => false, 'message' => 'Invalid request'];

if ($action === 'get_upazilas') {
    $district_id = isset($_GET['district_id']) ? (int)$_GET['district_id'] : 0;
    if ($district_id > 0) {
        $stmt = $mysqli->prepare("SELECT id, name_bd FROM holdings_upazilas WHERE district_id = ? ORDER BY name_bd ASC");
        $stmt->bind_param("i", $district_id);
        $stmt->execute();
        $result = $stmt->get_result();
        $upazilas = [];
        while ($row = $result->fetch_assoc()) { $upazilas[] = $row; }
        $stmt->close();
        $response = ['success' => true, 'upazilas' => $upazilas];
    } else { $response['message'] = 'District ID required.'; }
    echo json_encode($response);
    exit;
}

if ($action === 'get_moujas') {
    $upazila_id = isset($_GET['upazila_id']) ? (int)$_GET['upazila_id'] : 0;
    if ($upazila_id > 0) {
        $stmt = $mysqli->prepare( "SELECT DISTINCT m.id, m.name_bd FROM holdings_moujas m JOIN holdings_core hc ON hc.mouja_id = m.id WHERE hc.upazila_id = ? ORDER BY m.name_bd ASC" );
        $stmt->bind_param("i", $upazila_id);
        $stmt->execute();
        $result = $stmt->get_result();
        $moujas = [];
        while ($row = $result->fetch_assoc()) { $moujas[] = $row; }
        $stmt->close();
        $response = ['success' => true, 'moujas' => $moujas];
    } else { $response['message'] = 'Upazila ID required.'; }
    echo json_encode($response);
    exit;
}

if (isset($_GET['holding_id'])) {
    $holding_id = (int)$_GET['holding_id'];
    $holdingData = null; $ownersData = []; $schedulesData = [];
    $stmt = $mysqli->prepare(" SELECT hdm.*, hc.khotian_no AS khotian_no_core, hc.is_approve AS is_approve_core, hdm.holding_no as holding_no_main, hdm.district_name as district_name_main, hdm.upazila_name as upazila_name_main, hdm.mouja_name as mouja_name_main, hdm.is_approve as is_approve_main, dist.name_bn as district_name_core_ref, upa.name_bd as upazila_name_core_ref, mou.name_bd as mouja_name_core_ref FROM holdings_details_main hdm LEFT JOIN holdings_core hc ON hdm.core_holding_id = hc.id LEFT JOIN holdings_districts dist ON hc.district_id = dist.id LEFT JOIN holdings_upazilas upa ON hc.upazila_id = upa.id LEFT JOIN holdings_moujas mou ON hc.mouja_id = mou.id WHERE hdm.core_holding_id = ? LIMIT 1 ");
    $stmt->bind_param("i", $holding_id);
    $stmt->execute();
    $result = $stmt->get_result();
    if ($row = $result->fetch_assoc()) {
        $holdingData = $row;
        $holdingData['district_name_core'] = $row['district_name_core_ref'] ?? $row['district_name_main'];
        $holdingData['upazila_name_core'] = $row['upazila_name_core_ref'] ?? $row['upazila_name_main'];
        $holdingData['mouja_name_core'] = $row['mouja_name_core_ref'] ?? $row['mouja_name_main'];
    }
    $stmt->close();

    if ($holdingData) {
        $stmt = $mysqli->prepare("SELECT id, name, father_name, address, mobile_no, nid, land_portion, tax_clear_year as tax_clear_year_owner FROM holdings_owners WHERE ldtax_holding_id = ?");
        $stmt->bind_param("i", $holding_id);
        $stmt->execute();
        $result = $stmt->get_result();
        while ($row = $result->fetch_assoc()) { $ownersData[] = $row; }
        $stmt->close();

        $stmt = $mysqli->prepare(" SELECT hls.*, hls.khotian_no as khotian_no_schedule, hlut.amount AS amount_tax, hlut.current_demand AS current_demand_tax, hlut.start_year, hlut.end_year FROM holdings_land_schedules hls LEFT JOIN holdings_land_usage_tax hlut ON hls.id = hlut.schedule_id AND hls.holding_id = hlut.holding_id WHERE hls.holding_id = ? ");
        $stmt->bind_param("i", $holding_id);
        $stmt->execute();
        $result = $stmt->get_result();
        $tempSchedules = [];
        while ($row = $result->fetch_assoc()) {
            $schedule_main_id = $row['id'];
            if (!isset($tempSchedules[$schedule_main_id])) { $tempSchedules[$schedule_main_id] = [ 'id' => $row['id'], 'holding_id' => $row['holding_id'], 'office_id' => $row['office_id'], 'khotian_no_schedule' => $row['khotian_no_schedule'], 'dag_no' => $row['dag_no'], 'land_type' => $row['land_type'], 'amount_of_land' => $row['amount_of_land'], 'comments' => $row['comments'], 'status' => $row['status'], 'land_type_name' => $row['land_type_name'], 'tax_info' => null ]; }
            if ($row['amount_tax'] !== null && $tempSchedules[$schedule_main_id]['tax_info'] === null) { $tempSchedules[$schedule_main_id]['tax_info'] = [ 'amount_tax' => $row['amount_tax'], 'current_demand_tax' => $row['current_demand_tax'], 'start_year' => $row['start_year'], 'end_year' => $row['end_year'] ]; }
        }
        $schedulesData = array_values($tempSchedules);
        $stmt->close();
        $response = [ 'success' => true, 'holdingData' => $holdingData, 'ownersData' => $ownersData, 'schedulesData' => $schedulesData ];
    } else { $response['message'] = "Holding not found."; }
    echo json_encode($response);
    exit;
}

$page = isset($_GET['page']) ? (int)$_GET['page'] : 1;
$limit = isset($_GET['limit']) ? (int)$_GET['limit'] : 15;
$offset = ($page - 1) * $limit;

$search = isset($_GET['search']) ? $mysqli->real_escape_string(trim($_GET['search'])) : '';
$filterOwnerName = isset($_GET['owner_name']) ? $mysqli->real_escape_string(trim($_GET['owner_name'])) : '';
$filterFatherName = isset($_GET['father_name']) ? $mysqli->real_escape_string(trim($_GET['father_name'])) : '';
$filterKhotianNo = isset($_GET['khotian_no']) ? $mysqli->real_escape_string(trim($_GET['khotian_no'])) : '';
$filterDagNo = isset($_GET['dag_no']) ? $mysqli->real_escape_string(trim($_GET['dag_no'])) : '';
$filterNid = isset($_GET['nid']) ? $mysqli->real_escape_string(trim($_GET['nid'])) : '';
$filterMobile = isset($_GET['mobile_no']) ? $mysqli->real_escape_string(trim($_GET['mobile_no'])) : ''; // New
$district_id = isset($_GET['district_id']) ? (int)$_GET['district_id'] : 0;
$upazila_id = isset($_GET['upazila_id']) ? (int)$_GET['upazila_id'] : 0;
$mouja_id = isset($_GET['mouja_id']) ? (int)$_GET['mouja_id'] : 0;

$baseWhereClauses = [];
$allParams = [];
$allTypes = "";

if ($district_id > 0) { $baseWhereClauses[] = "hdm.district_id = ?"; $allParams[] = &$district_id; $allTypes .= "i"; }
if ($upazila_id > 0) { $baseWhereClauses[] = "hdm.upazila_id = ?"; $allParams[] = &$upazila_id; $allTypes .= "i"; }
if ($mouja_id > 0) { $baseWhereClauses[] = "hdm.mouja_id = ?"; $allParams[] = &$mouja_id; $allTypes .= "i"; }

$searchRelatedConditions = [];
$ownerSpecificConditions = [];
$landScheduleSpecificConditions = [];
$nidMobileSpecificConditions = [];

$search_term_for_like = "";
if (!empty($search)) {
    $search_term_for_like = "%" . $search . "%";
    $searchRelatedConditions[] = "hdm.holding_no LIKE ?"; $allParams[] = &$search_term_for_like; $allTypes .= "s";
    $searchRelatedConditions[] = "hc.holding_no LIKE ?"; $allParams[] = &$search_term_for_like; $allTypes .= "s";
    $searchRelatedConditions[] = "hdm.district_name LIKE ?"; $allParams[] = &$search_term_for_like; $allTypes .= "s";
    $searchRelatedConditions[] = "hdm.upazila_name LIKE ?"; $allParams[] = &$search_term_for_like; $allTypes .= "s";
    $searchRelatedConditions[] = "hdm.mouja_name LIKE ?"; $allParams[] = &$search_term_for_like; $allTypes .= "s";
    $searchRelatedConditions[] = "ho_search_generic.name LIKE ?"; $allParams[] = &$search_term_for_like; $allTypes .= "s";
    $searchRelatedConditions[] = "ho_search_generic.father_name LIKE ?"; $allParams[] = &$search_term_for_like; $allTypes .= "s";
    $searchRelatedConditions[] = "ho_search_generic.nid LIKE ?"; $allParams[] = &$search_term_for_like; $allTypes .= "s";
    $searchRelatedConditions[] = "ho_search_generic.mobile_no LIKE ?"; $allParams[] = &$search_term_for_like; $allTypes .= "s";
    $searchRelatedConditions[] = "hc.khotian_no LIKE ?"; $allParams[] = &$search_term_for_like; $allTypes .= "s";
    $searchRelatedConditions[] = "hls_search_generic.khotian_no LIKE ?"; $allParams[] = &$search_term_for_like; $allTypes .= "s";
    $searchRelatedConditions[] = "hls_search_generic.dag_no LIKE ?"; $allParams[] = &$search_term_for_like; $allTypes .= "s";
}

$filter_owner_name_like = "";
if (!empty($filterOwnerName)) {
    $filter_owner_name_like = "%" . $filterOwnerName . "%";
    $ownerSpecificConditions[] = "ho_filter_name_father.name LIKE ?"; $allParams[] = &$filter_owner_name_like; $allTypes .= "s";
}
$filter_father_name_like = "";
if (!empty($filterFatherName)) {
    $filter_father_name_like = "%" . $filterFatherName . "%";
    $ownerSpecificConditions[] = "ho_filter_name_father.father_name LIKE ?"; $allParams[] = &$filter_father_name_like; $allTypes .= "s";
}
if (!empty($filterNid)) {
    $nidMobileSpecificConditions[] = "ho_filter_nid_mobile.nid = ?"; $allParams[] = &$filterNid; $allTypes .= "s";
}
if (!empty($filterMobile)) {
    $nidMobileSpecificConditions[] = "ho_filter_nid_mobile.mobile_no = ?"; $allParams[] = &$filterMobile; $allTypes .= "s";
}
$filter_khotian_no_like = "";
if (!empty($filterKhotianNo)) {
    $filter_khotian_no_like = "%" . $filterKhotianNo . "%";
    $landScheduleSpecificConditions[] = "(hc.khotian_no LIKE ? OR hls_filter.khotian_no LIKE ?)";
    $allParams[] = &$filter_khotian_no_like; $allTypes .= "s";
    $allParams[] = &$filter_khotian_no_like; $allTypes .= "s";
}
$filter_dag_no_like = "";
if (!empty($filterDagNo)) {
    $filter_dag_no_like = "%" . $filterDagNo . "%";
    $landScheduleSpecificConditions[] = "hls_filter.dag_no LIKE ?";
    $allParams[] = &$filter_dag_no_like; $allTypes .= "s";
}

$sqlFromAndJoins = " FROM holdings_details_main hdm LEFT JOIN holdings_core hc ON hdm.core_holding_id = hc.id LEFT JOIN ( SELECT ldtax_holding_id, GROUP_CONCAT(DISTINCT name SEPARATOR ', ') as owner_names_concatenated FROM holdings_owners GROUP BY ldtax_holding_id ) ho_display ON hdm.core_holding_id = ho_display.ldtax_holding_id LEFT JOIN holdings_districts dist_main ON hdm.district_id = dist_main.id LEFT JOIN holdings_upazilas upa_main ON hdm.upazila_id = upa_main.id LEFT JOIN holdings_moujas mou_main ON hdm.mouja_id = mou_main.id LEFT JOIN holdings_districts dist_core ON hc.district_id = dist_core.id LEFT JOIN holdings_upazilas upa_core ON hc.upazila_id = upa_core.id LEFT JOIN holdings_moujas mou_core ON hc.mouja_id = mou_core.id ";

if (!empty($search)) {
    $sqlFromAndJoins .= " LEFT JOIN holdings_owners ho_search_generic ON hdm.core_holding_id = ho_search_generic.ldtax_holding_id ";
    $sqlFromAndJoins .= " LEFT JOIN holdings_land_schedules hls_search_generic ON hdm.core_holding_id = hls_search_generic.holding_id ";
}
if (!empty($filterOwnerName) || !empty($filterFatherName)) {
    $sqlFromAndJoins .= " JOIN holdings_owners ho_filter_name_father ON hdm.core_holding_id = ho_filter_name_father.ldtax_holding_id ";
}
if (!empty($filterNid) || !empty($filterMobile)) {
    $sqlFromAndJoins .= " JOIN holdings_owners ho_filter_nid_mobile ON hdm.core_holding_id = ho_filter_nid_mobile.ldtax_holding_id ";
}
if (!empty($filterKhotianNo) || !empty($filterDagNo)) {
    $sqlFromAndJoins .= " JOIN holdings_land_schedules hls_filter ON hdm.core_holding_id = hls_filter.holding_id ";
}

$finalWhereClauses = $baseWhereClauses;
if (!empty($searchRelatedConditions)) { $finalWhereClauses[] = "(" . implode(" OR ", $searchRelatedConditions) . ")"; }
if (!empty($ownerSpecificConditions)) { foreach ($ownerSpecificConditions as $cond) { $finalWhereClauses[] = $cond; } }
if (!empty($nidMobileSpecificConditions)) { foreach ($nidMobileSpecificConditions as $cond) { $finalWhereClauses[] = $cond; } }
if (!empty($landScheduleSpecificConditions)) { foreach ($landScheduleSpecificConditions as $cond) { $finalWhereClauses[] = $cond; } }

$sqlWhere = "";
if (!empty($finalWhereClauses)) { $sqlWhere = "WHERE " . implode(" AND ", $finalWhereClauses); }

$countQuery = "SELECT COUNT(DISTINCT hdm.auto_id) as total " . $sqlFromAndJoins . $sqlWhere;
$stmt = $mysqli->prepare($countQuery);
if ($stmt === false) { $response = ['success' => false, 'message' => 'Error preparing count query: ' . $mysqli->error, 'query_debug' => $countQuery, 'params_debug' => $allParams, 'types_debug' => $allTypes]; echo json_encode($response); exit; }
if (!empty($allParams)) { $stmt->bind_param($allTypes, ...$allParams); }
$stmt->execute();
$totalRecordsResult = $stmt->get_result()->fetch_assoc();
$totalRecords = $totalRecordsResult['total'] ?? 0;
$totalPages = ceil($totalRecords / $limit);
$stmt->close();

$dataParams = $allParams;
$dataTypes = $allTypes;
$limit_param_data = $limit; $offset_param_data = $offset;
$dataParams[] = &$limit_param_data; $dataTypes .= "i";
$dataParams[] = &$offset_param_data; $dataTypes .= "i";

$dataQuery = " SELECT DISTINCT hdm.auto_id, hdm.core_holding_id, hdm.holding_no AS holding_no_main, hc.holding_no AS holding_no_core, ho_display.owner_names_concatenated as owner_name, COALESCE(dist_main.name_bn, dist_core.name_bn) as district_name, COALESCE(upa_main.name_bd, upa_core.name_bd) as upazila_name, COALESCE(mou_main.name_bd, mou_core.name_bd) as mouja_name, hdm.tax_clear_year, hdm.total_demand " . $sqlFromAndJoins . $sqlWhere . " ORDER BY hdm.auto_id DESC LIMIT ? OFFSET ? ";
$stmt = $mysqli->prepare($dataQuery);
if ($stmt === false) { $response = ['success' => false, 'message' => 'Error preparing data query: ' . $mysqli->error, 'query_debug' => $dataQuery, 'params_debug' => $dataParams, 'types_debug' => $dataTypes]; echo json_encode($response); exit; }
if (!empty($dataParams)) { $stmt->bind_param($dataTypes, ...$dataParams); }
$stmt->execute();
$result = $stmt->get_result();
$data = [];
while ($row = $result->fetch_assoc()) { $data[] = $row; }
$stmt->close();

$response = [ 'success' => true, 'data' => $data, 'currentPage' => $page, 'totalPages' => $totalPages, 'totalRecords' => $totalRecords, 'limit' => $limit ];
echo json_encode($response);
exit;
?>

# /tools/name-search.php
  <?php
// This file is included by the main tools.php
// Assumes $selected_tool, BASE_URL, esc() are available.

// PHP survey data - sorted for display
$SURVEY_types_php = [
    1 => ['সি এস', 'CS', 4], 2 => ['আর এস', 'RS', 1], 3 => ['এস এ', 'SA', 3],
    4 => ['বি এস', 'BS', 2], 5 => ['দিয়ারা', 'DIARA', 3], 6 => ['পেটি', 'PETY', 4],
    7 => ['বি আর এস', 'BRS', 2], 8 => ['বি ডি এস', 'BDS', 6],
];
uasort($SURVEY_types_php, function ($a, $b) { return ($a[2] ?? 99) <=> ($b[2] ?? 99); });

// --- Get initial values from $_GET ---
$initial_division_id = isset($_GET['division_id']) ? filter_input(INPUT_GET, 'division_id', FILTER_SANITIZE_NUMBER_INT) : '';
$initial_district_id = isset($_GET['district_id']) ? filter_input(INPUT_GET, 'district_id', FILTER_SANITIZE_NUMBER_INT) : '';
$initial_upazila_id = isset($_GET['upazila_id']) ? filter_input(INPUT_GET, 'upazila_id', FILTER_SANITIZE_NUMBER_INT) : '';
$initial_survey_id = isset($_GET['survey_id']) ? filter_input(INPUT_GET, 'survey_id', FILTER_SANITIZE_NUMBER_INT) : '';
$initial_owner = isset($_GET['owner']) ? trim(filter_input(INPUT_GET, 'owner', FILTER_SANITIZE_FULL_SPECIAL_CHARS)) : '';
$initial_guardian = isset($_GET['guardian']) ? trim(filter_input(INPUT_GET, 'guardian', FILTER_SANITIZE_FULL_SPECIAL_CHARS)) : '';
$initial_page = isset($_GET['page']) ? filter_input(INPUT_GET, 'page', FILTER_SANITIZE_NUMBER_INT) : 1;
$initial_page = max(1, (int)$initial_page);

// Determine if a search should be triggered on load
// Requires Survey, District, and Owner/Guardian
$triggerSearch = !empty($initial_survey_id)
    && (!empty($initial_owner) || !empty($initial_guardian))
    && !empty($initial_district_id);

// URL for the AJAX file that handles get_divisions, get_districts, etc.
$location_ajax_url = 'https://4bd.org/api/ajax.php'; // As requested
?>

<!DOCTYPE html> <?php // Added basic HTML structure for standalone testing if needed ?>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>নাম, জরিপ ও এলাকা দ্বারা খতিয়ান অনুসন্ধান</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <!-- Font Awesome via CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Alpine.js via CDN -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Define Location API URL -->
    <script>
        window.LOCATION_API_BASE_URL = '<?= htmlspecialchars($location_ajax_url, ENT_QUOTES, 'UTF-8') ?>';
    </script>

    <!-- CSS for Mobile Table Labels -->
    <style>
        [x-cloak] { display: none !important; }
        @media (max-width: 767px) {
            #name-search-results-tbody > tr > td[data-label]::before {
                content: attr(data-label); position: absolute; left: 0.75rem; top: 0.6rem;
                padding-right: 0.5rem; text-align: left; font-weight: 600; font-size: 0.75rem;
                color: #4b5563; white-space: nowrap;
            }
            .dark #name-search-results-tbody > tr > td[data-label]::before { color: #9ca3af; }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 py-8">

<div class="container mx-auto px-2 md:px-4" <?php // Added responsive padding ?>
     x-data="searchByNameApp({
            initialDivisionId: '<?= esc($initial_division_id) ?>',
            initialDistrictId: '<?= esc($initial_district_id) ?>',
            initialUpazilaId: '<?= esc($initial_upazila_id) ?>',
            initialSurveyId: '<?= esc($initial_survey_id) ?>',
            initialOwner: '<?= esc($initial_owner) ?>',
            initialGuardian: '<?= esc($initial_guardian) ?>',
            initialPage: <?= $initial_page ?>,
            triggerSearchOnLoad: <?= $triggerSearch ? 'true' : 'false' ?>
         })"
     x-init="initLocationData()"
     x-cloak>

    <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg">

        <h1 class="text-xl sm:text-2xl font-bold mb-6 text-emerald-700 dark:text-emerald-300 border-b border-gray-200 dark:border-gray-600 pb-3">নাম, জরিপ ও এলাকা দ্বারা খতিয়ান অনুসন্ধান</h1>

        <!-- Search Form - Uses GET method -->
        <form method="GET" action="<?= htmlspecialchars(BASE_URL . '/tools.php', ENT_QUOTES, 'UTF-8'); ?>"> <?php // Use BASE_URL if defined ?>
            <input type="hidden" name="tool" value="<?= esc($selected_tool['slug'] ?? 'name-search'); ?>"> <?php // Use selected_tool if defined ?>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                <?php // --- Location Filters --- ?>
                <div>
                    <label for="division_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">বিভাগ</label>
                    <select id="division_id" name="division_id" x-model="selectedDivision" @change="handleDivisionChange()"
                            class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 disabled:opacity-60"
                            :disabled="loadingDivisions">
                        <option value="">-- নির্বাচন করুন --</option>
                        <template x-for="division in divisions" :key="division.id">
                            <option :value="division.id" x-text="division.name"></option>
                        </template>
                    </select>
                    <span x-show="loadingDivisions" class="text-xs text-emerald-600 dark:text-emerald-400">লোড হচ্ছে...</span>
                </div>
                <div>
                    <label for="district_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">জেলা <span class="text-red-500">*</span></label>
                    <select id="district_id" name="district_id" x-model="selectedDistrict" @change="handleDistrictChange()" required
                            class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 disabled:opacity-60"
                            :disabled="!selectedDivision || loadingDistricts">
                        <option value="">-- বিভাগ নির্বাচন করুন --</option>
                        <template x-for="district in districts" :key="district.id">
                            <option :value="district.id" :data-bbs_code="district.bbs_code" x-text="district.name"></option>
                        </template>
                    </select>
                    <span x-show="loadingDistricts" class="text-xs text-emerald-600 dark:text-emerald-400">লোড হচ্ছে...</span>
                </div>
                <div>
                    <label for="upazila_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">উপজেলা/থানা</label>
                    <select id="upazila_id" name="upazila_id" x-model="selectedUpazila" @change="handleUpazilaChange()"
                            class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 disabled:opacity-60"
                            :disabled="!selectedDistrict || loadingUpazilas">
                        <option value="">-- জেলা নির্বাচন করুন --</option>
                        <option value="-1">(সকল উপজেলা)</option>
                        <template x-for="upazila in upazilas" :key="upazila.id">
                            <option :value="upazila.id" :data-bbs_code="upazila.bbs_code" x-text="upazila.name"></option>
                        </template>
                    </select>
                    <span x-show="loadingUpazilas" class="text-xs text-emerald-600 dark:text-emerald-400">লোড হচ্ছে...</span>
                </div>

                <?php // --- Survey, Owner, Guardian Filters --- ?>
                <div>
                    <label for="survey_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">জরিপের ধরণ <span class="text-red-500">*</span></label>
                    <select id="survey_id" name="survey_id" x-model="surveySearchId" required
                            class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 disabled:bg-gray-200 dark:disabled:bg-gray-600 disabled:cursor-not-allowed">
                        <option value="">-- জরিপ নির্বাচন করুন --</option>
                        <?php foreach ($SURVEY_types_php as $id => $details): ?>
                            <option value="<?= $id ?>" <?= ($id == $initial_survey_id) ? 'selected' : '' ?>>
                                <?= htmlspecialchars($details[0]) ?> (<?= htmlspecialchars($details[1]) ?>)
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div>
                    <label for="owner_search" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">মালিকের নাম (আংশিক) <span x-show="!guardianSearch.trim()" class="text-red-500">*</span></label>
                    <input type="text" id="owner_search" name="owner" x-model="ownerSearch" placeholder="মালিকের নাম লিখুন..."
                           class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:ring-emerald-500 focus:border-emerald-500 dark:placeholder-gray-400">
                </div>
                <div>
                    <label for="guardian_search" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">অভিভাবকের নাম (আংশিক) <span x-show="!ownerSearch.trim()" class="text-red-500">*</span></label>
                    <input type="text" id="guardian_search" name="guardian" x-model="guardianSearch" placeholder="অভিভাবকের নাম লিখুন..."
                           class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:ring-emerald-500 focus:border-emerald-500 dark:placeholder-gray-400">
                </div>
            </div>
            <input type="hidden" name="page" value="1">

            <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">জরিপের ধরণ, জেলা <span class="font-semibold">(আবশ্যক)</span> এবং মালিক অথবা অভিভাবকের নামের অংশ লিখে "অনুসন্ধান" বাটনে ক্লিক করুন।</p>
            <div class="flex justify-end items-center">
                <button type="submit"
                        :disabled="!surveySearchId || !selectedDistrict || (!ownerSearch.trim() && !guardianSearch.trim()) || loading"
                        class="px-5 py-2 bg-emerald-600 text-white font-semibold rounded shadow-sm hover:bg-emerald-700 dark:bg-emerald-700 dark:hover:bg-emerald-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 dark:focus:ring-offset-gray-800 disabled:opacity-60 disabled:cursor-not-allowed transition duration-150 ease-in-out">
                    <i class="fas fa-spinner fa-spin mr-1" x-show="loading"></i>
                    <i class="fas fa-search mr-1" x-show="!loading"></i>
                    <span x-show="!loading">অনুসন্ধান</span>
                    <span x-show="loading">অনুসন্ধান করা হচ্ছে...</span>
                </button>
            </div>
        </form>

        <hr class="my-6 sm:my-8 border-gray-300 dark:border-gray-600">

        <!-- Results Section -->
        <div id="results">
            <?php // Loading Indicators ?>
            <div x-show="loading && !searchPerformed" class="text-center p-6 text-gray-600 dark:text-gray-400">
                <i class="fas fa-spinner fa-spin text-2xl text-blue-500 dark:text-blue-400"></i>
                <span class="ml-2 text-lg" x-text="loadingMessage">প্রাথমিক ডাটা লোড হচ্ছে...</span>
            </div>
            <div x-show="loading && searchPerformed" class="text-center p-6 text-gray-600 dark:text-gray-400">
                <i class="fas fa-spinner fa-spin text-2xl text-blue-500 dark:text-blue-400"></i>
                <span class="ml-2 text-lg" x-text="loadingMessage">ফলাফল লোড হচ্ছে...</span>
            </div>

            <?php // Content Area when not loading and search was attempted ?>
            <div x-show="!loading && searchPerformed">

                <?php // Mobile Filters Section ?>
                <div x-show="results.length > 0" class="mb-4 p-4 border border-gray-200 dark:border-gray-700 rounded bg-white dark:bg-gray-700 block md:hidden">
                    <h3 class="text-lg font-semibold mb-3 text-gray-700 dark:text-gray-200">ফলাফল ফিল্টার করুন</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div><label for="mf_khatian_no" class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">খতিয়ান নং</label><input type="text" id="mf_khatian_no" x-model.debounce.300ms="columnFilters.khatian_no" placeholder="নং..." class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:ring-emerald-500 focus:border-emerald-500 dark:placeholder-gray-400"></div>
                        <div><label for="mf_mouza_jl" class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">মৌজা (জে.এল)</label><input type="text" id="mf_mouza_jl" x-model.debounce.300ms="columnFilters.mouza_jl" placeholder="মৌজা/জে.এল..." class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:ring-emerald-500 focus:border-emerald-500 dark:placeholder-gray-400"></div>
                        <div><label for="mf_survey" class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">জরিপ</label><input type="text" id="mf_survey" x-model.debounce.300ms="columnFilters.survey" placeholder="জরিপ..." class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:ring-emerald-500 focus:border-emerald-500 dark:placeholder-gray-400"></div>
                        <div><label for="mf_owner_guardian" class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">মালিক/অভিভাবক</label><input type="text" id="mf_owner_guardian" x-model.debounce.300ms="columnFilters.owner_guardian" placeholder="নাম..." class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:ring-emerald-500 focus:border-emerald-500 dark:placeholder-gray-400"></div>
                        <div><label for="mf_dags" class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">দাগ (আংশিক)</label><input type="text" id="mf_dags" x-model.debounce.300ms="columnFilters.dags" placeholder="দাগ..." class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:ring-emerald-500 focus:border-emerald-500 dark:placeholder-gray-400"></div>
                        <div><label for="mf_total_land" class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">মোট জমি</label><input type="text" id="mf_total_land" x-model.debounce.300ms="columnFilters.total_land" placeholder="জমি..." class="w-full p-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:ring-emerald-500 focus:border-emerald-500 dark:placeholder-gray-400"></div>
                    </div>
                </div>

                <?php // Results Table/Cards Wrapper ?>
                <div x-show="totalItems > 0">
                    <h2 class="text-lg sm:text-xl font-semibold mb-4 text-gray-700 dark:text-gray-200">
                        অনুসন্ধানের ফল
                        (<span x-text="filteredResults.length"></span> টি প্রদর্শিত<template x-if="isAnyFilterActive() && filteredResults.length !== results.length"> (ফিল্টারকৃত)</template>, মোট <span x-text="totalItems"></span>)
                    </h2>
                    <div class="overflow-x-auto shadow border border-gray-200 dark:border-gray-700 rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <?php // Table Head with Filter Row ?>
                            <thead class="bg-white dark:bg-gray-700 hidden md:table-header-group">
                            <tr> <?php // Header labels ?>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">খতিয়ান নং</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">মৌজা (জে.এল)</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">জরিপ</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">মালিক/অভিভাবক</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">দাগ (আংশিক)</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">মোট জমি</th>
                            </tr>
                            <tr class="filter-row hidden md:table-row border-t border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700"> <?php // Filter inputs ?>
                                <th class="p-2"><input type="text" x-model.debounce.300ms="columnFilters.khatian_no" placeholder="নং..." class="w-full p-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:ring-emerald-500 focus:border-emerald-500 dark:placeholder-gray-400"></th>
                                <th class="p-2"><input type="text" x-model.debounce.300ms="columnFilters.mouza_jl" placeholder="মৌজা/জে.এল..." class="w-full p-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:ring-emerald-500 focus:border-emerald-500 dark:placeholder-gray-400"></th>
                                <th class="p-2"><input type="text" x-model.debounce.300ms="columnFilters.survey" placeholder="জরিপ..." class="w-full p-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:ring-emerald-500 focus:border-emerald-500 dark:placeholder-gray-400"></th>
                                <th class="p-2"><input type="text" x-model.debounce.300ms="columnFilters.owner_guardian" placeholder="নাম..." class="w-full p-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:ring-emerald-500 focus:border-emerald-500 dark:placeholder-gray-400"></th>
                                <th class="p-2"><input type="text" x-model.debounce.300ms="columnFilters.dags" placeholder="দাগ..." class="w-full p-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:ring-emerald-500 focus:border-emerald-500 dark:placeholder-gray-400"></th>
                                <th class="p-2"><input type="text" x-model.debounce.300ms="columnFilters.total_land" placeholder="জমি..." class="w-full p-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:ring-emerald-500 focus:border-emerald-500 dark:placeholder-gray-400"></th>
                            </tr>
                            </thead>
                            <tbody id="name-search-results-tbody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700 md:divide-y-0">
                            <?php // Message when client filters hide all rows ?>
                            <template x-if="filteredResults.length === 0 && totalItems > 0">
                                <tr class="block md:table-row">
                                    <td colspan="6" data-label="বার্তা" class="text-center py-6 px-4 text-gray-500 dark:text-gray-400 block md:table-cell text-sm md:text-base">
                                        <i class="fas fa-info-circle mr-2"></i>
                                        <span>আপনার ফিল্টারের সাথে মেলে এমন কোন ফলাফল এই পৃষ্ঠায় নেই।</span>
                                    </td>
                                </tr>
                            </template>
                            <?php // Loop through filtered results ?>
                            <template x-for="item in filteredResults" :key="item.khatian_id + '-' + item.survey_id">
                                <tr class="block md:table-row mb-4 md:mb-0 border md:border-0 border-gray-200 dark:border-gray-700 rounded-lg md:rounded-none shadow md:shadow-none overflow-hidden md:overflow-visible bg-white dark:bg-gray-800 hover:bg-white dark:hover:bg-gray-700/60 md:odd:bg-white md:dark:odd:bg-gray-800 md:even:bg-white md:dark:even:bg-gray-700 transition duration-150">
                                    <td data-label="খতিয়ান নং" class="block md:table-cell px-3 md:px-4 py-2 md:py-3 relative md:static text-right md:text-left border-b md:border-b-0 border-gray-200 dark:border-gray-700 md:border-white md:dark:border-gray-700 text-sm font-medium text-gray-900 dark:text-gray-100" x-text="item.khatian_no"></td>
                                    <td data-label="মৌজা (জে.এল)" class="block md:table-cell px-3 md:px-4 py-2 md:py-3 relative md:static text-right md:text-left border-b md:border-b-0 border-gray-200 dark:border-gray-700 md:border-white md:dark:border-gray-700 text-sm text-gray-600 dark:text-gray-300"> <span x-text="item.mouza_name"></span> (<span x-text="item.jl_number"></span>) </td>
                                    <td data-label="জরিপ" class="block md:table-cell px-3 md:px-4 py-2 md:py-3 relative md:static text-right md:text-left border-b md:border-b-0 border-gray-200 dark:border-gray-700 md:border-white md:dark:border-gray-700 text-sm text-gray-500 dark:text-gray-400" x-text="getSurveyName(item.survey_id)"></td>
                                    <td data-label="মালিক/অভিভাবক" class="block md:table-cell px-3 md:px-4 py-2 md:py-3 relative md:static text-right md:text-left border-b md:border-b-0 border-gray-200 dark:border-gray-700 md:border-white md:dark:border-gray-700 text-sm text-gray-700 dark:text-gray-300" x-html="formatOwners(item.owners, item.guardians)"></td>
                                    <td data-label="দাগ (আংশিক)" class="block md:table-cell px-3 md:px-4 py-2 md:py-3 relative md:static text-right md:text-left border-b md:border-b-0 border-gray-200 dark:border-gray-700 md:border-white md:dark:border-gray-700 text-sm text-gray-500 dark:text-gray-400 break-all md:break-normal md:truncate" x-text="item.dags ? item.dags.substring(0, 60) + (item.dags.length > 60 ? '...' : '') : ''"></td>
                                    <td data-label="মোট জমি" class="block md:table-cell px-3 md:px-4 py-2 md:py-3 relative md:static text-right md:text-left border-b md:border-b-0 border-gray-200 dark:border-gray-700 md:border-white md:dark:border-gray-700 text-sm text-gray-500 dark:text-gray-400" x-text="item.total_land"></td>
                                </tr>
                            </template>
                            </tbody>
                        </table>
                    </div>

                    <?php // Pagination Links ?>
                    <div class="mt-5 flex justify-between items-center" x-show="totalPages > 1">
                        <a :href="currentPage > 1 ? generatePageUrl(currentPage - 1) : '#'"
                           :class="{ 'opacity-60 cursor-not-allowed pointer-events-none': currentPage <= 1 }"
                           class="px-3 py-1.5 text-sm bg-blue-500 dark:bg-blue-600 text-white rounded shadow-sm hover:bg-blue-600 dark:hover:bg-blue-700 transition duration-150"
                           aria-label="Previous Page">
                            <i class="fas fa-arrow-left mr-1"></i> পূর্ববর্তী
                        </a>
                        <span class="text-xs sm:text-sm text-gray-700 dark:text-gray-300">
                                 Page <span x-text="currentPage" class="font-semibold"></span> of <span x-text="totalPages" class="font-semibold"></span>
                                 (<span x-text="totalItems"></span> items)
                             </span>
                        <a :href="currentPage < totalPages ? generatePageUrl(currentPage + 1) : '#'"
                           :class="{ 'opacity-60 cursor-not-allowed pointer-events-none': currentPage >= totalPages }"
                           class="px-3 py-1.5 text-sm bg-blue-500 dark:bg-blue-600 text-white rounded shadow-sm hover:bg-blue-600 dark:hover:bg-blue-700 transition duration-150"
                           aria-label="Next Page">
                            পরবর্তী <i class="fas fa-arrow-right ml-1"></i>
                        </a>
                    </div>
                </div>

                <?php // Message: Initial search yielded no results ?>
                <div x-show="results.length === 0 && totalItems === 0 && !errorMessage" class="text-center p-6 text-gray-500 dark:text-gray-400 border border-gray-200 dark:border-gray-700 rounded-lg mt-4">
                    <i class="fas fa-search fa-lg mr-2"></i> আপনার অনুসন্ধানের জন্য কোন খতিয়ান পাওয়া যায়নি।
                </div>

                <?php // Global Error Message Area ?>
                <div x-show="errorMessage" x-transition
                     class="mt-4 p-3 bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 border border-red-300 dark:border-red-700 rounded text-sm"
                     x-text="errorMessage">
                </div>
            </div> <?php // End !loading && searchPerformed block ?>
        </div> <?php // End #results ?>
    </div> <?php // End main content wrapper ?>

</div> <?php // End Container & Alpine Scope ?>


<?php // --- Alpine JS logic (Copied from previous correct version) --- ?>
<script>
    if (typeof searchByNameApp !== 'function') {
        function searchByNameApp(initialData = {}) {
            return {
                // --- State Properties ---
                apiBaseUrl: 'https://4bd.org/api/name-search-ajax.php',
                locationApiBaseUrl: window.LOCATION_API_BASE_URL,
                divisions: [], districts: [], upazilas: [],
                selectedDivision: initialData.initialDivisionId || '',
                selectedDistrict: initialData.initialDistrictId || '',
                selectedUpazila: initialData.initialUpazilaId || '',
                selectedDistrictBbsCode: '',
                selectedUpazilaBbsCode: '',
                loadingDivisions: false, loadingDistricts: false, loadingUpazilas: false,
                ownerSearch: initialData.initialOwner || '',
                guardianSearch: initialData.initialGuardian || '',
                surveySearchId: initialData.initialSurveyId || '',
                results: [], filteredResultsCache: [],
                loading: false, loadingMessage: 'লোড হচ্ছে...', searchPerformed: false,
                currentPage: initialData.initialPage || 1, totalPages: 0, totalItems: 0,
                pageSize: 500,
                errorMessage: '', errorMessageTimeout: null,
                surveyTypes: {"2":["আর এস","RS",1],"4":["বি এস","BS",2],"7":["বি আর এস","BRS",2],"3":["এস এ","SA",3],"5":["দিয়ারা","DIARA",3],"1":["সি এস","CS",4],"6":["পেটি","PETY",4],"8":["বি ডি এস","BDS",6]},
                columnFilters: { khatian_no: '', mouza_jl: '', survey: '', owner_guardian: '', dags: '', total_land: '' },
                _filterCacheKey: '',

                // --- Computed Properties ---
                isAnyFilterActive() { return Object.values(this.columnFilters).some(filter => filter.trim() !== ''); },
                get filteredResults() {
                    if (this._filterCacheKey === this.generateFilterCacheKey()) { return this.filteredResultsCache; }
                    this._filterCacheKey = this.generateFilterCacheKey();
                    if (!this.isAnyFilterActive()) { this.filteredResultsCache = this.results;}
                    else { this.filteredResultsCache = this.results.filter(item => { const check = (v, k) => { const ft = this.columnFilters[k]?.trim().toLowerCase(); if (!ft) return true; return String(v ?? '').toLowerCase().includes(ft);}; return check(item.khatian_no, 'khatian_no') && check(`${item.mouza_name ?? ''} (${item.jl_number ?? ''})`, 'mouza_jl') && check(this.getSurveyName(item.survey_id), 'survey') && check(`${item.owners ?? ''} ${item.guardians ?? ''}`, 'owner_guardian') && check(item.dags, 'dags') && check(item.total_land, 'total_land'); }); }
                    return this.filteredResultsCache;
                },
                generateFilterCacheKey() { return `${this.results.length}-${JSON.stringify(this.columnFilters)}`; },

                // --- Initialization ---
                async initLocationData() {
                    await this.fetchDivisions();
                    this.$nextTick(async () => {
                        if (this.selectedDivision) {
                            await this.fetchDistricts(true);
                            this.$nextTick(async () => {
                                if (this.selectedDistrict) { await this.fetchUpazilas(true); }
                                this.updateSelectedDistrictBbsCode(); this.updateSelectedUpazilaBbsCode();
                                if (initialData.triggerSearchOnLoad) {
                                    if(this.surveySearchId && this.selectedDistrictBbsCode && (this.ownerSearch.trim() || this.guardianSearch.trim())) { setTimeout(() => { this.fetchResults(this.currentPage, true); }, 50); }
                                    else { console.warn("Auto-search conditions not fully met after initial location loading."); this.searchPerformed = true; }
                                } else { this.searchPerformed = !!(initialData.initialSurveyId && initialData.initialDistrictId && (initialData.initialOwner || initialData.initialGuardian)); }
                            });
                        } else { this.searchPerformed = !!(initialData.initialSurveyId && initialData.initialDistrictId && (initialData.initialOwner || initialData.initialGuardian)); }
                    });
                },

                // --- Location Fetch Methods ---
                async fetchDivisions() { this.loadingDivisions = true; const d = await this._fetchLocationData('action=get_divisions'); if (d !== null) this.divisions = Array.isArray(d) ? d : []; this.loadingDivisions = false; },
                async fetchDistricts(isInitialLoad = false) { if (!this.selectedDivision) { if(!isInitialLoad) this._resetDistricts(); return; } if (!isInitialLoad) this._resetDistricts(); this.loadingDistricts = true; const d = await this._fetchLocationData(`action=get_districts&division_id=${this.selectedDivision}`); if (d !== null) this.districts = Array.isArray(d) ? d : []; this.loadingDistricts = false; this.updateSelectedDistrictBbsCode(); },
                async fetchUpazilas(isInitialLoad = false) { if (!this.selectedDistrict) { if(!isInitialLoad) this._resetUpazilas(); return; } if (!isInitialLoad) this._resetUpazilas(); this.loadingUpazilas = true; const d = await this._fetchLocationData(`action=get_upazilas&district_id=${this.selectedDistrict}`); if (d !== null) this.upazilas = Array.isArray(d) ? d : []; this.loadingUpazilas = false; this.updateSelectedUpazilaBbsCode(); },
                async _fetchLocationData(endpoint) { this._clearError(); try { const r = await fetch(`${this.locationApiBaseUrl}?${endpoint}`); if (!r.ok) throw new Error(`Location fetch failed (${r.status})`); const d = await r.json(); if (!d.success) throw new Error(d.message || 'Failed to fetch location data'); return d.data; } catch (error) { console.error("Location fetch error:", error); return null; } },

                // --- Location Change Handlers ---
                handleDivisionChange() { this._resetDistricts(); if(this.selectedDivision) { this.fetchDistricts(); } },
                handleDistrictChange() { this._resetUpazilas(); if(this.selectedDistrict) { this.updateSelectedDistrictBbsCode(); this.fetchUpazilas(); } else { this.selectedDistrictBbsCode = ''; } },
                handleUpazilaChange() { this.updateSelectedUpazilaBbsCode(); },
                _resetDistricts() { this.districts = []; this.selectedDistrict = ''; this.selectedDistrictBbsCode = ''; this._resetUpazilas(); },
                _resetUpazilas() { this.upazilas = []; this.selectedUpazila = ''; this.selectedUpazilaBbsCode = ''; },
                updateSelectedDistrictBbsCode() { const dData = this.districts.find(d => d.id == this.selectedDistrict); this.selectedDistrictBbsCode = dData ? dData.bbs_code : ''; },
                updateSelectedUpazilaBbsCode() { if (this.selectedUpazila == '-1' || !this.selectedUpazila) { this.selectedUpazilaBbsCode = ''; } else { const uData = this.upazilas.find(u => u.id == this.selectedUpazila); this.selectedUpazilaBbsCode = uData ? uData.bbs_code : ''; } },

                // --- Core Search Fetch Method ---
                _clearError() { this.errorMessage = ''; if (this.errorMessageTimeout) clearTimeout(this.errorMessageTimeout); },
                _showError(message) { console.error("Name Search Error:", message); this.errorMessage = `ত্রুটি: ${message}`; if (this.errorMessageTimeout) clearTimeout(this.errorMessageTimeout); this.errorMessageTimeout = setTimeout(() => this._clearError(), 8000); },
                async fetchResults(page, isInitialLoad = false) { const ownerTerm = this.ownerSearch.trim(); const guardianTerm = this.guardianSearch.trim(); const surveyId = this.surveySearchId; const districtBbs = this.selectedDistrictBbsCode; const upazilaBbs = this.selectedUpazilaBbsCode; if (!surveyId) { if (!isInitialLoad) this._showError("জরিপের ধরণ নির্বাচন করুন।"); return; } if (!districtBbs) { if (!isInitialLoad) this._showError("জেলা নির্বাচন করুন।"); return; } if (!ownerTerm && !guardianTerm) { if (!isInitialLoad) this._showError("মালিক অথবা অভিভাবকের নাম লিখুন।"); return; } this.searchPerformed = true; this.loading = true; this.loadingMessage = isInitialLoad ? 'প্রাথমিক ডাটা লোড হচ্ছে...' : `পৃষ্ঠা ${page} লোড হচ্ছে...`; this._clearError(); if (page === 1) { this.results = []; this.filteredResultsCache = []; this._filterCacheKey = ''; this.totalItems = 0; this.totalPages = 0; } try { const params = new URLSearchParams({ action: 'search_by_name', survey_id: surveyId, district_bbs_code: districtBbs, page: page, pageSize: this.pageSize }); if (upazilaBbs) params.append('upazila_bbs_code', upazilaBbs); if (ownerTerm) params.append('owner_search', ownerTerm); if (guardianTerm) params.append('guardian_search', guardianTerm); const response = await fetch(`${this.apiBaseUrl}?${params.toString()}`); if (!response.ok) { let eB = `Server Error (${response.status})`; try { const ej = await response.json(); eB = ej.message || eB; } catch(e){} throw new Error(eB); } const data = await response.json(); if (!data.success) { throw new Error(data.message || 'Search failed'); } if (data.data && Array.isArray(data.data.khatians)) { this.results = data.data.khatians; this.totalItems = data.data.totalItems || 0; this.totalPages = data.data.totalPages || 0; this.currentPage = data.data.currentPage || 1; this.columnFilters = { khatian_no: '', mouza_jl: '', survey: '', owner_guardian: '', dags: '', total_land: '' }; this.filteredResultsCache = []; this._filterCacheKey = ''; } else { console.error("Invalid data structure:", data); throw new Error("Invalid data received"); } } catch (error) { this._showError(error.message); if (page === 1) { this.results = []; this.totalItems = 0; this.totalPages = 0; this.filteredResultsCache = []; this._filterCacheKey = '';} } finally { this.loading = false; } },

                // --- Pagination URL Generation ---
                generatePageUrl(targetPage) { const params = new URLSearchParams(window.location.search); params.set('page', targetPage); params.set('tool', 'name-search'); if (this.selectedDivision) params.set('division_id', this.selectedDivision); else params.delete('division_id'); if (this.selectedDistrict) params.set('district_id', this.selectedDistrict); else params.delete('district_id'); if (this.selectedUpazila && this.selectedUpazila != '-1') params.set('upazila_id', this.selectedUpazila); else params.delete('upazila_id'); if (this.surveySearchId) params.set('survey_id', this.surveySearchId); else params.delete('survey_id'); if (this.ownerSearch.trim()) params.set('owner', this.ownerSearch.trim()); else params.delete('owner'); if (this.guardianSearch.trim()) params.set('guardian', this.guardianSearch.trim()); else params.delete('guardian'); const baseUrl = '<?= htmlspecialchars(BASE_URL . '/tools.php', ENT_QUOTES, 'UTF-8'); ?>'; return `${baseUrl}?${params.toString()}`; },

                // --- Utility Methods ---
                getSurveyName(surveyId) { return this.surveyTypes[surveyId] ? this.surveyTypes[surveyId][0] : (surveyId ?? 'Unknown'); },
                formatOwners(owners, guardians) { const esc=(u)=>{if(typeof u!=='string')return'';return u.replace(/&/g,"&").replace(/</g,"<").replace(/>/g,">").replace(/"/g,"\"").replace(/'/g,"'");};let oL=String(owners??"").trim()?String(owners).split(',').map(o=>esc(o.trim())).filter(Boolean):[];let oH=oL.length>0?oL.join('<br>'):'-';let gS=String(guardians??"");if(gS&&gS!=='0'&&gS.trim()!==''){const gL=gS.split(',').map(g=>esc(g.trim())).filter(Boolean);if(gL.length>0){oH+=`<br><span class='mt-1 block text-xs text-gray-500 dark:text-gray-400'><strong>অভিভাবক:</strong> ${gL.join('<br>')}</span>`;}}return oH;}

                }; // End return object
                } // End searchByNameApp function
            } // End if typeof check
</script>
<?php // --- END Alpine JS logic --- ?>

</body>
</html>
# /api/name-search-ajax.php
                  <?php

header('Access-Control-Allow-Origin: *'); // Allow all origins for CORS
header('Access-Control-Allow-Methods: GET, POST, OPTIONS'); // Allow specific methods

header('Content-Type: application/json; charset=utf-8');
$stattime = microtime(1);
$host = "172.188.89.41";
$username = "bdland";
$password = "8WF7LLRWHALsFjinvFU4";
$database = "bdland";

// --- Database Connection ---
$mysqli = new mysqli($host, $username, $password, $database);
if ($mysqli->connect_errno) {
    echo json_encode(['success' => false, 'message' => "DB Connect failed: " . $mysqli->connect_error, 'data' => null]);
    exit();
}
if (!$mysqli->set_charset('utf8mb4')) {
    echo json_encode(['success' => false, 'message' => "Error loading charset utf8mb4: " . $mysqli->error, 'data' => null]);
    $mysqli->close();
    exit();
}

// --- Input Sanitization & Initialization ---
$owner_search = filter_input(INPUT_GET, 'owner_search', FILTER_SANITIZE_STRING, FILTER_FLAG_NO_ENCODE_QUOTES);
$guardian_search = filter_input(INPUT_GET, 'guardian_search', FILTER_SANITIZE_STRING, FILTER_FLAG_NO_ENCODE_QUOTES);
$selected_survey_id = filter_input(INPUT_GET, 'survey_id', FILTER_VALIDATE_INT);
$page = filter_input(INPUT_GET, 'page', FILTER_VALIDATE_INT, ['options' => ['default' => 1, 'min_range' => 1]]);
$pageSize = filter_input(INPUT_GET, 'pageSize', FILTER_VALIDATE_INT, ['options' => ['default' => 20, 'min_range' => 1]]);
$action = $_GET['action'] ?? null;

$rowid = 0; // For caching

// --- Survey Mapping ---
$SURVEY_MAP = [
    1 => 'CS', 2 => 'RS', 3 => 'SA', 4 => 'BS',
    5 => 'DIARA', 6 => 'PETY', 7 => 'BRS', 8 => 'BDS',
];

// --- Response Template ---
$response = ['success' => false, 'message' => 'Invalid action', 'data' => []];
$searchDataTemplate = [
    'khatians' => [], 'totalItems' => 0, 'totalPages' => 0,
    'currentPage' => $page, 'pageSize' => $pageSize
];
$response['data'] = $searchDataTemplate;

try {
    switch ($action) {
        case 'search_by_name':
            $response['data']['currentPage'] = $page;
            $response['data']['pageSize'] = $pageSize;

            // --- Input Validation ---
            if (empty($selected_survey_id) || !isset($SURVEY_MAP[$selected_survey_id])) {
                $response['message'] = 'অনুগ্রহ করে একটি বৈধ জরিপের ধরণ নির্বাচন করুন।';
                break;
            }

            $trimmed_owner = trim($owner_search ?? '');
            $trimmed_guardian = trim($guardian_search ?? '');
            $has_owner_term = !empty($trimmed_owner);
            $has_guardian_term = !empty($trimmed_guardian);

            if (!$has_owner_term && !$has_guardian_term) {
                $response['success'] = true;
                $response['message'] = "অনুসন্ধানের জন্য মালিক অথবা অভিভাবকের নাম লিখুন।";
                break;
            }

            // --- Caching Logic (Check) ---
            // Caching key remains the same
            $selected_survey_idx_esc = $mysqli->real_escape_string($selected_survey_id);
            $owner_search_esc = $mysqli->real_escape_string($trimmed_owner);
            $guardian_search_esc = $mysqli->real_escape_string($trimmed_guardian);
            $current_time = time();
            $cache_expiry_seconds = 60 * 10; // 10 minutes cache
            $cache_expiry_seconds = 600000010; // 10 minutes cache

            $cacheSql = "SELECT id, resp, time FROM `dlrms_src_names` WHERE `survey_id` = '{$selected_survey_idx_esc}' and `owner` = '{$owner_search_esc}' and  `guardian` = '{$guardian_search_esc}' limit 1";
            $cacheQuery = $mysqli->query($cacheSql);

            if ($cacheQuery && $cacheQuery->num_rows > 0) {
                // ... (cache retrieval logic - unchanged) ...
                $row = $cacheQuery->fetch_assoc();
                $rowid = $row['id'];
                $cacheTime = (int)$row['time'];
                $cachedResponse = $row['resp'];
                if (!empty($cachedResponse) && ($current_time - $cacheTime) < $cache_expiry_seconds) {
                    $decodedCache = json_decode($cachedResponse, true);
                    if (json_last_error() === JSON_ERROR_NONE && isset($decodedCache['success'])) {
                        $endtime_cache = microtime(true);
                        $decodedCache['timetaken'] = round($endtime_cache - $stattime, 4);
                        $decodedCache['message'] .= " (Cached)";
                        echo json_encode($decodedCache, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
                        if ($mysqli instanceof mysqli && $mysqli->thread_id) { $mysqli->close(); }
                        exit();
                    }
                }
            } else {
                // ... (cache placeholder insertion - unchanged) ...
                $insertCacheSql = "INSERT INTO `dlrms_src_names`(`survey_id`, `owner`, `guardian`, `time`, `resp`) VALUES ('{$selected_survey_idx_esc}','{$owner_search_esc}','{$guardian_search_esc}','{$current_time}', NULL)
                                  ON DUPLICATE KEY UPDATE time = VALUES(time)";
                $mysqli->query($insertCacheSql);
                $rowid = $mysqli->insert_id ?: $rowid;
                if ($rowid == 0) {
                    $refetchCacheSql = "SELECT id FROM `dlrms_src_names` WHERE `survey_id` = '{$selected_survey_idx_esc}' and `owner` = '{$owner_search_esc}' and  `guardian` = '{$guardian_search_esc}' limit 1";
                    $refetchResult = $mysqli->query($refetchCacheSql);
                    if($refetchResult && $refetchResult->num_rows > 0){
                        $rowid = $refetchResult->fetch_assoc()['id'];
                        $refetchResult->free_result();
                    }
                }
            }
            if ($cacheQuery) $cacheQuery->free_result();


            // --- Prepare SQL based on provided terms ---
            $surveyKey = $SURVEY_MAP[$selected_survey_id];
            $khatianTableName = "dlrms_khatians_" . $surveyKey;

            $whereClauses = [];
            $params = [];
            $types = "";

            if ($has_owner_term && $has_guardian_term) {
                // **BOTH terms provided: Use LIKE for strict column matching**
                $whereClauses[] = "k.owners LIKE ?";
                $whereClauses[] = "k.guardians LIKE ?";
                // Prepare parameters for LIKE (add wildcards)
                $params[] = "%" . $mysqli->real_escape_string($trimmed_owner) . "%";
                $params[] = "%" . $mysqli->real_escape_string($trimmed_guardian) . "%";
                $types .= "ss"; // Two string parameters

            } elseif ($has_owner_term) {
                // **ONLY owner term provided: Use FULLTEXT for potential speed**
                $whereClauses[] = "MATCH(k.owners, k.guardians) AGAINST (? IN BOOLEAN MODE)";
                // Prepare parameter for AGAINST (require the term)
                $params[] = "+" . $mysqli->real_escape_string($trimmed_owner);
                $types .= "s"; // One string parameter

            } elseif ($has_guardian_term) {
                // **ONLY guardian term provided: Use FULLTEXT for potential speed**
                $whereClauses[] = "MATCH(k.owners, k.guardians) AGAINST (? IN BOOLEAN MODE)";
                // Prepare parameter for AGAINST (require the term)
                $params[] = "+" . $mysqli->real_escape_string($trimmed_guardian);
                $types .= "s"; // One string parameter
            }

            // Combine WHERE clauses (will be 'AND' if using LIKE, single clause if using MATCH)
            $whereSql = "WHERE " . implode(" AND ", $whereClauses);

            // --- Count Total Items ---
            $totalItems = 0;
            $totalPages = 0;
            $offset = ($page - 1) * $pageSize;

            $countSql = "SELECT COUNT(k.id) as total FROM {$khatianTableName} k {$whereSql}";
            $countStmt = $mysqli->prepare($countSql);
            if ($countStmt) {
                // Bind parameters based on the built $types and $params
                if (!empty($types)) {
                    $countStmt->bind_param($types, ...$params);
                }
                if ($countStmt->execute()) {
                    $countResult = $countStmt->get_result();
                    $totalItems = (int) $countResult->fetch_assoc()['total'];
                    $totalPages = $totalItems > 0 ? ceil($totalItems / $pageSize) : 0;
                    $response['data']['totalItems'] = $totalItems;
                    $response['data']['totalPages'] = $totalPages;
                } else {
                    $response['message'] = 'Error executing count: ' . $countStmt->error;
                    error_log('Error executing count: ' . $countStmt->error . ' SQL: ' . $countSql . ' Params: '. json_encode($params));
                    $countStmt->close();
                    break;
                }
                $countStmt->close();
            } else {
                $response['message'] = 'Error preparing count: ' . $mysqli->error;
                error_log('Error preparing count: ' . $mysqli->error . ' SQL: ' . $countSql);
                break;
            }

            // --- Fetch Khatian Data ---
            $khatiansData = [];
            if ($totalItems > 0 && $offset < $totalItems) {
                // Prepare parameters for the data query (same as count + LIMIT/OFFSET)
                $dataParams = $params; // Parameters for WHERE clause
                $dataTypes = $types;   // Types for WHERE clause
                $dataParams[] = $pageSize;
                $dataTypes .= "i";     // Add type for LIMIT
                $dataParams[] = $offset;
                $dataTypes .= "i";     // Add type for OFFSET

                $dataSql = "SELECT k.id as khatian_id, k.*, mj.mouza_name, mj.jl_number, mj.survey_id
                            FROM {$khatianTableName} k
                            INNER JOIN dlrms_mouza_jl_numbers mj ON k.jl_number_id = mj.id
                            {$whereSql}
                            ORDER BY k.id -- Or other relevant order
                            LIMIT ? OFFSET ?";
                $stmt = $mysqli->prepare($dataSql);
                if ($stmt) {
                    // Bind parameters (WHERE + LIMIT + OFFSET)
                    if (!empty($dataTypes)) {
                        $stmt->bind_param($dataTypes, ...$dataParams);
                    }
                    if ($stmt->execute()) {
                        $result = $stmt->get_result();
                        $khatiansData = $result->fetch_all(MYSQLI_ASSOC);
                        $result->free_result();
                    } else {
                        $response['message'] = 'Error executing data query: ' . $stmt->error;
                        error_log('Error executing data query: ' . $stmt->error . ' SQL: ' . $dataSql . ' Params: '. json_encode($dataParams));
                    }
                    $stmt->close();
                } else {
                    $response['message'] = 'Error preparing data query: ' . $mysqli->error;
                    error_log('Error preparing data query: ' . $mysqli->error . ' SQL: ' . $dataSql);
                }
            }

            $response['data']['khatians'] = $khatiansData;
            $response['success'] = true;
            $response['message'] = $totalItems > 0 ? 'Search results fetched.' : 'No matching khatians found.';
            break; // End case 'search_by_name'

        default:
            $response['message'] = 'Invalid action specified';
            $response['data'] = [];
            break;
    }
} catch (mysqli_sql_exception $e) {
    // ... (Exception handling - unchanged) ...
    error_log("Database Error: " . $e->getMessage() . " (Code: " . $e->getCode() . ")");
    $response['success'] = false; $response['message'] = 'Database error occurred.'; $response['data'] = [];
} catch (Exception $e) {
    // ... (Exception handling - unchanged) ...
    error_log("General Error: " . $e->getMessage() . "\n" . $e->getTraceAsString());
    $response['success'] = false; $response['message'] = 'Unexpected server error.'; $response['data'] = [];
}

// --- Calculate Time & Update Cache ---
$endtime = microtime(true);
$totaltime = $endtime - $stattime;
$response['timetaken'] = round($totaltime, 4);

$jsonData = json_encode($response, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);

if ($action === 'search_by_name' && $response['success'] && $rowid > 0) {
    // ... (Cache update logic - unchanged) ...
    $jsonDataEsc = $mysqli->real_escape_string($jsonData);
    $updateCacheTime = time();
    $mysqli->query("UPDATE `dlrms_src_names` SET resp='{$jsonDataEsc}', time='{$updateCacheTime}' WHERE id = '{$rowid}'");
} elseif ($action === 'search_by_name' && $response['success'] && $rowid == 0) {
    // ... (Error log if cache rowid missing - unchanged) ...
    error_log("Successful search but failed to get rowid for caching: survey={$selected_survey_id}, owner={$owner_search_esc}, guardian={$guardian_search_esc}");
}


// --- Close Connection & Output ---
if ($mysqli instanceof mysqli && $mysqli->thread_id) {
    $mysqli->close();
}

echo $jsonData;
exit();
?>

